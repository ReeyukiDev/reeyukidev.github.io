(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();class L{constructor(e,t){this.fs=e,this.wm=t,this.currentPath=["home","reeyuki"],this.history=[],this.historyIndex=-1,this.username="reeyuki",this.hostname="desktop-os",this.printQueue=Promise.resolve(),this.commands={},this.registerDefaultCommands(),this.pageLoadTime=Date.now()}async print(e,t=null,n=!1,s=null,i=30){const o=document.createElement("div"),r=document.createElement("span");if(n){const a=document.createElement("span");a.textContent=s||this.terminalPrompt.textContent,a.style.color="white",o.appendChild(a),o.appendChild(r)}else t&&(r.style.color=t),o.appendChild(r);this.terminalOutput.appendChild(o);for(let a=0;a<e.length;a++)r.textContent+=e[a],await new Promise(c=>setTimeout(c,i)),this.terminalOutput.parentElement.scrollTop=this.terminalOutput.parentElement.scrollHeight}enqueuePrint(...e){return this.printQueue=this.printQueue.then(()=>this.print(...e)),this.printQueue}setupEventHandlers(){this.terminalInput.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();const t=this.terminalInput.value.trim();if(!t)return;this.history.push(t),this.historyIndex=this.history.length,this.terminalInput.value="",this.executeCommand(t)}else if(e.key==="ArrowUp"&&this.historyIndex>0)e.preventDefault(),this.terminalInput.value=this.history[--this.historyIndex];else if(e.key==="ArrowDown")e.preventDefault(),this.historyIndex=Math.min(this.historyIndex+1,this.history.length),this.terminalInput.value=this.historyIndex<this.history.length?this.history[this.historyIndex]:"";else if(e.key==="Tab")e.preventDefault(),this.handleTabCompletion();else if(e.ctrlKey)if(e.key==="l")e.preventDefault(),this.cmdClear();else if(e.key==="d"){e.preventDefault();const t=document.getElementById("terminal-win");t&&(this.wm.removeFromTaskbar(t.id),t.remove())}else e.key==="c"&&(e.preventDefault(),this.enqueuePrint("^C","white",!0,this.terminalPrompt.textContent),this.terminalInput.value="")}),document.getElementById("terminal-win").addEventListener("click",()=>{this.terminalInput.focus()})}executeCommand(e){this.enqueuePrint(e,null,!0,this.terminalPrompt.textContent);const[t,...n]=e.trim().split(/\s+/),s={help:()=>this.cmdHelp(),clear:()=>this.cmdClear(),ls:()=>this.cmdLs(n),pwd:()=>this.enqueuePrint(this.currentPath.length>0?"/"+this.currentPath.join("/"):"/"),cd:()=>this.cmdCd(n),mkdir:()=>this.cmdFileOp(n,"mkdir","missing operand",()=>this.fs.createFolder(this.currentPath,n[0]),"Created directory"),touch:()=>this.cmdFileOp(n,"touch","missing file operand",()=>this.fs.createFile(this.currentPath,n[0],""),"Created file"),rm:()=>this.cmdFileOp(n,"rm","missing operand",()=>this.fs.deleteItem(this.currentPath,n[0]),"Removed"),cat:()=>this.cmdCat(n),echo:()=>this.enqueuePrint(n.join(" ")),whoami:()=>this.enqueuePrint(this.username),hostname:()=>this.enqueuePrint(this.hostname),date:()=>this.enqueuePrint(new Date().toString()),history:()=>this.history.forEach((i,o)=>this.enqueuePrint(`  ${o+1}  ${i}`)),tree:()=>this.cmdTree(),uname:()=>this.enqueuePrint("Linux reeyuki-desktop 6.1.23-arch1-1 #1 SMP PREEMPT x86_64 GNU/Linux"),neofetch:()=>this.cmdNeofetch(),ping:()=>this.cmdPing(n),curl:()=>this.cmdCurl(n),ps:()=>this.cmdPs()};s[t]?s[t]():t&&this.enqueuePrint(`bash: ${t}: command not found`),this.updatePrompt()}open(){const e=document.getElementById("terminal-win");if(e)return this.wm.bringToFront(e);const t=this.wm.createWindow("terminal-win","Terminal","700px","500px");Object.assign(t.style,{left:"200px",top:"100px"}),t.innerHTML=`
      <div class="window-header">
        <span>Terminal</span>
        <div class="window-controls">
          <button class="minimize-btn" title="Minimize">−</button>
          <button class="maximize-btn" title="Maximize">□</button>
          <button class="close-btn" title="Close">X</button>
        </div>
      </div>
      <div class="window-content" style="background:#000; color:white; font-family:monospace; padding:10px; overflow-y:auto; height:calc(100% - 40px);">
        <div id="terminal-output" style="white-space: pre;"></div>
        <div id="terminal-input-line" style="display:flex;">
          <span id="terminal-prompt"></span>
          <input type="text" id="terminal-input" style="flex:1; background:transparent; border:none; color:white; font-family:monospace; outline:none; margin-left:5px;" autocomplete="off">
        </div>
      </div>
    `,desktop.appendChild(t),this.wm.makeDraggable(t),this.wm.makeResizable(t),this.wm.setupWindowControls(t),this.wm.addToTaskbar(t.id,"Terminal"),this.terminalOutput=t.querySelector("#terminal-output"),this.terminalInput=t.querySelector("#terminal-input"),this.terminalPrompt=t.querySelector("#terminal-prompt"),this.updatePrompt(),this.terminalInput.focus(),this.print("Welcome to Reeyuki's silly terminal"),this.print(`Type 'help' for available commands
`),this.setupEventHandlers()}updatePrompt(){const e=this.currentPath.length?"/"+this.currentPath.join("/"):"/";this.terminalPrompt.textContent=`${this.username}@${this.hostname}:${e}$ `}handleTabCompletion(){const e=this.terminalInput.value,t=this.terminalInput.selectionStart,n=e.slice(0,t),s=n.match(/(\S+)$/);if(!s)return;const i=s[1],o=n.slice(0,n.length-i.length);let r,a;if(i.includes("/")){const p=i.split("/");a=p.pop(),r=this.fs.resolvePath(p.join("/"),this.currentPath)}else r=[...this.currentPath],a=i;let c;try{c=Object.keys(this.fs.getFolder(r))}catch{return}const l=c.filter(p=>p.startsWith(a));if(l.length)if(l.length===1){const p=l[0]+(this.fs.isFile(r,l[0])?"":"/");this.terminalInput.value=o+p+e.slice(t),this.terminalInput.selectionStart=this.terminalInput.selectionEnd=o.length+p.length}else{const p=l.reduce((m,h)=>{let u=0;for(;u<m.length&&u<h.length&&m[u]===h[u];)u++;return m.slice(0,u)},l[0]);p.length>a.length?(this.terminalInput.value=o+p+e.slice(t),this.terminalInput.selectionStart=this.terminalInput.selectionEnd=o.length+p.length):this.print(l.join("  "))}}registerCommand(e,t){this.commands[e]=t}registerFileCommand(e,t,n,s){this.registerCommand(e,i=>{if(!i.length)return this.print(`${e}: ${s}`);try{t(this.currentPath,i[0]),this.print(`${n}: ${i[0]}`)}catch(o){this.print(`${e}: cannot process '${i[0]}': ${o.message}`)}})}registerDefaultCommands(){this.registerCommand("help",async()=>{const e=Object.keys(this.commands).sort();await this.print("Available commands:");for(const t of e)await this.print(`  ${t}`)}),this.registerCommand("clear",()=>this.cmdClear()),this.registerCommand("pwd",()=>this.print(this.currentPath.length?"/"+this.currentPath.join("/"):"/")),this.registerCommand("ls",e=>this.cmdLs(e)),this.registerCommand("cd",e=>this.cmdCd(e)),this.registerFileCommand("mkdir",(e,t)=>this.fs.createFolder(e,t),"Created directory","missing operand"),this.registerFileCommand("touch",(e,t)=>this.fs.createFile(e,t,""),"Created file","missing file operand"),this.registerFileCommand("rm",(e,t)=>this.fs.deleteItem(e,t),"Removed","missing operand"),this.registerCommand("cat",e=>this.cmdCat(e)),this.registerCommand("echo",e=>this.print(e.join(" "))),this.registerCommand("whoami",()=>this.print(this.username)),this.registerCommand("hostname",()=>this.print(this.hostname)),this.registerCommand("date",()=>this.print(new Date().toString())),this.registerCommand("history",()=>this.history.forEach((e,t)=>this.print(`  ${t+1}  ${e}`))),this.registerCommand("tree",()=>this.cmdTree()),this.registerCommand("uname",()=>this.print("Linux reeyuki-desktop 6.1.23-arch1-1 #1 SMP PREEMPT x86_64 GNU/Linux")),this.registerCommand("ping",e=>this.cmdPing(e)),this.registerCommand("curl",e=>this.cmdCurl(e)),this.registerCommand("neofetch",()=>this.cmdNeofetch()),this.registerCommand("ps",()=>this.cmdPs())}cmdClear(){this.terminalOutput.innerHTML=""}cmdLs(e){try{const t=e.length?this.fs.resolvePath(e[0],this.currentPath):this.currentPath;Object.keys(this.fs.getFolder(t)).forEach(n=>{const s=this.fs.isFile(t,n);this.print(n+(s?"":"/"),s?null:"blue")})}catch{this.print(`ls: cannot access '${e[0]}': No such file or directory`)}}cmdCd(e){if(!e.length||e[0]==="~")this.currentPath=["home",this.username];else try{const t=this.fs.resolvePath(e[0],this.currentPath);if(!this.fs.getFolder(t))return this.print(`cd: ${e[0]}: Not a directory`);this.currentPath=t}catch{this.print(`cd: ${e[0]}: No such file or directory`)}}cmdCat(e){if(!e.length)return this.print("cat: missing file operand");const t=e[0];try{if(!this.fs.isFile(this.currentPath,t))return this.print(`cat: ${t}: Is a directory`);this.print(this.fs.getFileContent(this.currentPath,t)||"(empty file)")}catch{this.print(`cat: ${t}: No such file or directory`)}}async cmdPing(e){if(!e.length)return this.print("Usage: ping <host>");const t=e[0].startsWith("http")?e[0]:"https://"+e[0];await this.print(`PING ${e[0]} ...`);const n=performance.now();try{await fetch(t,{method:"HEAD",mode:"no-cors"})}catch{}await this.print(`Reply from ${e[0]}: time=${(performance.now()-n).toFixed(2)}ms`)}async cmdCurl(e){if(!e.length)return this.print("Usage: curl <url>");try{const t=await(await fetch(e[0])).text();await this.print(t.slice(0,1e3))}catch{await this.print(`curl: (6) Could not resolve host: ${e[0]}`)}}async cmdNeofetch(){const e=navigator.userAgent,t=/Firefox\/\d+/.test(e)?"Firefox":/Edg\/\d+/.test(e)?"Edge":/Chrome\/\d+/.test(e)?"Chrome":"Unknown",s=t==="Chrome"||t==="Edge"?"eww a chromium?!":t,i=navigator.hardwareConcurrency||"Unknown",o=i>10?`${i} (WOW ITS SO BIG!)`:i;let r="Unknown";try{const v=document.createElement("canvas"),w=v.getContext("webgl")||v.getContext("experimental-webgl");if(w){const C=w.getExtension("WEBGL_debug_renderer_info");r=C?w.getParameter(C.UNMASKED_RENDERER_WEBGL):w.getParameter(w.RENDERER)}}catch{}const a=Date.now()-this.pageLoadTime,c=Math.floor(a/36e5),l=Math.floor(a%36e5/6e4),p=`${c}h, ${l}m`;let m="Unknown";typeof InstallTrigger<"u"?m="SpiderMonkey":window.chrome&&/Google Inc/.test(navigator.vendor)?m="V8":/Apple/.test(navigator.vendor)&&(m="JavaScriptCore");let h="Unknown";/Windows NT 10/.test(e)?h="Windows 10/11":/Mac OS X/.test(e)?h="macOS":/Linux/.test(e)?h="Linux":/Android/.test(e)?h="Android":/iPhone|iPad/.test(e)&&(h="iOS");const u=h=="Windows 10/11"?"Eww a windows!":h,E=navigator.deviceMemory?`${navigator.deviceMemory} GB`:"Unknown",T=navigator.doNotTrack==="1"||window.doNotTrack==="1"?"Enabled":"Disabled",S=["","","                     "+this.username+"@"+this.hostname,`        /\\           OWOS     ${u}`,`       /  \\          KEWNEL   ${m}wu`,`      /\\   \\         CPUWU    Cwpu Cowes: ${o}`,`     / > ω <\\        BROWSEWU  ${s}`,`    /   __   \\       GWAPHU    ${r}`,`   / __|  |__-\\      MEMOWY    ${E}`,`  /_-''    ''-_\\     DoNawtTWACKWU  ${T}`,`                     RESOWUW   ${window.innerWidth}x${window.innerHeight}`,`                     UWUPTIME  ${p}`];for(const v of S)await this.enqueuePrint(v)}cmdPs(){const e=Array.from(document.querySelectorAll(".window"));this.print("  PID   TTY          TIME CMD"),e.length?e.forEach((t,n)=>{const s=t.querySelector(".window-header span")?.textContent||"unknown";this.print(`  ${1e3+n}  pts/0      0:00 ${s}`)}):this.print("  1     pts/0        0:00 idle")}cmdTree(e=this.currentPath,t=""){t||this.print(e.length?"/"+e.join("/"):"/");try{const n=Object.keys(this.fs.getFolder(e));n.forEach((s,i)=>{const o=this.fs.isFile(e,s),r=i===n.length-1;this.print(t+(r?"└── ":"├── ")+s+(o?"":"/")),o||this.cmdTree([...e,s],t+(r?"    ":"│   "))})}catch{this.print("tree: error reading directory")}}}const d=document.getElementById("context-menu"),g={IMAGE:"image",TEXT:"text"};class A{constructor(e,t,n){this.fs=e,this.wm=t,this.notepadApp=n,this.currentPath=["home","reeyuki"],this.fileSelectCallback=null,this.open=this.open.bind(this)}open(e=null){if(this.fileSelectCallback=e,document.getElementById("explorer-win")){this.wm.bringToFront(document.getElementById("explorer-win"));return}const t=document.createElement("div");t.className="window",t.id="explorer-win",t.dataset.fullscreen="false",t.innerHTML=`
      <div class="window-header">
        <span>File Explorer</span>
        <div class="window-controls">
          <button class="minimize-btn" title="Minimize">−</button>
          <button class="maximize-btn" title="Maximize">□</button>
          <button class="close-btn" title="Close">X</button>
        </div>
      </div>
      <div class="explorer-nav">
        <div class="back-btn" id="exp-back">← Back</div>
        <div id="exp-path" style="color:#555"></div>
      </div>
      <div class="explorer-container">
        <div class="explorer-sidebar">
          <div class="start-item" data-path="home/reeyuki/Documents">Documents</div>
          <div class="start-item" data-path="home/reeyuki/Pictures">Pictures</div>
          <div class="start-item" data-path="home/reeyuki/Music">Music</div>
        </div>
        <div class="explorer-main" id="explorer-view"></div>
      </div>
    `,desktop.appendChild(t),document.getElementById("explorer-view").style.width="600px",this.wm.makeDraggable(t),this.wm.makeResizable(t),this.wm.setupWindowControls(t),this.wm.addToTaskbar(t.id,"File Explorer"),this.setupExplorerControls(t),this.render()}setupExplorerControls(e){e.querySelector("#exp-back").onclick=()=>{this.currentPath.length>1&&(this.currentPath.pop(),this.render())},e.querySelectorAll(".explorer-sidebar .start-item").forEach(n=>{n.onclick=()=>{const s=n.dataset.path.split("/").filter(i=>i);this.navigate(s)}});const t=e.querySelector("#explorer-view");t.addEventListener("contextmenu",n=>{n.target===t&&this.showBackgroundContextMenu(n)})}navigate(e){this.currentPath=[...e],this.render()}renderMusicPage(e){e&&(e.innerHTML=`
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
      <iframe 
        src="https://open.spotify.com/embed/playlist/6oK6F4LglYBr4mYLSRDJOa" 
        width="300" 
        height="380" 
        frameborder="0" 
        allowtransparency="true" 
        allow="encrypted-media">
      </iframe>

      <iframe 
        src="https://open.spotify.com/embed/playlist/1q7zv2ScwtR2jIxaIRj9iG" 
        width="300" 
        height="380" 
        frameborder="0" 
        allowtransparency="true" 
        allow="encrypted-media">
      </iframe>

      <iframe 
        src="https://open.spotify.com/embed/playlist/6q8mgrJZ5L4YxabVQoAZZf" 
        width="300" 
        height="380" 
        frameborder="0" 
        allowtransparency="true" 
        allow="encrypted-media">
      </iframe>
    </div>
  `)}render(){const e=document.getElementById("explorer-view"),t=document.getElementById("exp-path");if(!e)return;if(e.innerHTML="",t.textContent="/"+this.currentPath.join("/"),this.currentPath[2]==="Music"){this.renderMusicPage(document.getElementById("explorer-view"));return}const n=this.fs.getFolder(this.currentPath);Object.keys(n).forEach(s=>{const i=this.fs.isFile(this.currentPath,s),o=document.createElement("div");o.className="file-item";let r;i?this.fs.getFileKind(this.currentPath,s)===g.IMAGE?r=this.fs.getFileContent(this.currentPath,s)||"/static/icons/file.png":r="/static/icons/notepad.png":r="/static/icons/file.png",o.innerHTML=`
      <img src="${r}" style="width:64px;height:64px;object-fit:cover">
      <span>${s}</span>
    `,o.ondblclick=()=>{if(i)if(this.fileSelectCallback)this.fileSelectCallback(this.currentPath,s),this.fileSelectCallback=null;else{const a=this.fs.getFileContent(this.currentPath,s);this.fs.getFileKind(this.currentPath,s)===g.IMAGE?this.openImageViewer(s,a):this.notepadApp.open(s,a,this.currentPath)}else this.currentPath.push(s),this.render()},o.oncontextmenu=a=>this.showFileContextMenu(a,s,i),e.appendChild(o)})}openImageViewer(e,t){const n=document.createElement("div");n.className="window",Object.assign(n.style,{width:"500px",height:"400px",left:"150px",top:"150px",zIndex:2e3}),n.innerHTML=`
      <div class="window-header">
        <span>${e}</span>
        <div class="window-controls">
          <button class="close-btn">X</button>
        </div>
      </div>
      <div style="display:flex;justify-content:center;align-items:center;height:calc(100% - 30px);background:#222">
        <img src="${t}" style="max-width:100%; max-height:100%">
      </div>
    `,desktop.appendChild(n),this.wm.makeDraggable(n),n.querySelector(".close-btn").onclick=()=>n.remove()}showFileContextMenu(e,t,n){e.preventDefault(),e.stopPropagation(),d.innerHTML="";const s=(a,c)=>{const l=document.createElement("div");return l.textContent=a,l.onclick=c,l},i=n?"Open":"Open Folder",o=()=>{if(d.style.display="none",n){const a=this.fs.getFileContent(this.currentPath,t);this.fs.getFileKind(this.currentPath,t)===g.IMAGE?this.openImageViewer(t,a):this.notepadApp.open(t,a,this.currentPath)}else this.currentPath.push(t),this.render()};if(d.appendChild(s(i,o)),n){d.appendChild(document.createElement("hr"));const a=()=>{d.style.display="none",this.fs.deleteItem(this.currentPath,t),this.render()};d.appendChild(s("Delete",a));const c=()=>{d.style.display="none";const l=prompt("Enter new name:",t);l&&l!==t&&(this.fs.renameItem(this.currentPath,t,l),this.render())};d.appendChild(s("Rename",c))}d.appendChild(document.createElement("hr"));const r=()=>{d.style.display="none",alert(`Name: ${t}
Type: ${n?"File":"Folder"}`)};d.appendChild(s("Properties",r)),Object.assign(d.style,{left:`${e.pageX}px`,top:`${e.pageY}px`,display:"block"})}showBackgroundContextMenu(e){e.preventDefault(),e.stopPropagation(),d.innerHTML=`
      <div id="ctx-new-file">New File</div>
      <div id="ctx-new-folder">New Folder</div>
      <hr>
      <div id="ctx-refresh">Refresh</div>
    `,document.getElementById("ctx-new-file").onclick=()=>{d.style.display="none";const t=prompt("Enter file name:","NewFile.txt");t&&(this.fs.createFile(this.currentPath,t),this.render())},document.getElementById("ctx-new-folder").onclick=()=>{d.style.display="none";const t=prompt("Enter folder name:","NewFolder");t&&(this.fs.createFolder(this.currentPath,t),this.render())},document.getElementById("ctx-refresh").onclick=()=>{d.style.display="none",this.render()},Object.assign(d.style,{left:`${e.pageX}px`,top:`${e.pageY}px`,display:"block"})}}class B{constructor(){this.openWindows=new Map,this.zIndexCounter=1e3}createWindow(e,t,n="80vw",s="80vh"){const i=document.createElement("div");i.className="window",i.id=e,i.dataset.fullscreen="false";const o=n.includes("vw")?window.innerWidth*parseFloat(n)/100:parseInt(n),r=s.includes("vh")?window.innerHeight*parseFloat(s)/100:parseInt(s);return Object.assign(i.style,{width:`${o}px`,height:`${r}px`,left:`${(window.innerWidth-o)/2}px`,top:`${(window.innerHeight-r)/2}px`,position:"absolute",zIndex:this.zIndexCounter++}),i}addToTaskbar(e,t){if(document.getElementById(`taskbar-${e}`))return;const n=document.createElement("div");n.id=`taskbar-${e}`,n.className="taskbar-item",n.textContent=t,Object.assign(n.style,{padding:"8px 15px",background:"#2a2a2a",color:"white",cursor:"pointer",borderRadius:"4px",marginRight:"5px",fontSize:"13px",maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}),n.onclick=()=>{const i=document.getElementById(e);i&&(i.style.display==="none"?(i.style.display="block",n.style.background="#2a2a2a"):this.bringToFront(i))},document.getElementById("taskbar-windows").appendChild(n),this.openWindows.set(e,{taskbarItem:n,title:t})}removeFromTaskbar(e){const t=document.getElementById(`taskbar-${e}`);t&&t.remove(),this.openWindows.delete(e)}bringToFront(e){e.style.zIndex=this.zIndexCounter++}minimizeWindow(e){e.style.display="none";const t=document.getElementById(`taskbar-${e.id}`);t&&(t.style.background="#1a1a1a")}toggleFullscreen(e){if(e.dataset.fullscreen==="true")document.fullscreenElement&&document.exitFullscreen(),e.style.width=e.dataset.prevWidth,e.style.height=e.dataset.prevHeight,e.style.left=e.dataset.prevLeft,e.style.top=e.dataset.prevTop,e.dataset.fullscreen="false";else{Object.assign(e.dataset,{prevWidth:e.style.width,prevHeight:e.style.height,prevLeft:e.style.left,prevTop:e.style.top});const n=()=>{Object.assign(e.style,{width:"100vw",height:"calc(100vh - 40px)",left:"0",top:"0"})};document.documentElement.requestFullscreen?document.documentElement.requestFullscreen().then(n).catch(n):n(),e.dataset.fullscreen="true"}}setupWindowControls(e){e.querySelector(".close-btn").onclick=()=>{this.removeFromTaskbar(e.id),e.remove()},e.querySelector(".minimize-btn").onclick=()=>this.minimizeWindow(e),e.querySelector(".maximize-btn").onclick=()=>this.toggleFullscreen(e),e.addEventListener("mousedown",()=>this.bringToFront(e))}makeDraggable(e){const t=e.querySelector(".window-header");t.onmousedown=n=>{if(n.target.tagName==="BUTTON")return;const s=n.clientX-e.offsetLeft,i=n.clientY-e.offsetTop;document.onmousemove=o=>{e.style.left=`${o.clientX-s}px`,e.style.top=`${o.clientY-i}px`},document.onmouseup=()=>document.onmousemove=null}}makeResizable(e){const t=document.createElement("div");Object.assign(t.style,{width:"10px",height:"10px",background:"transparent",position:"absolute",right:"0",bottom:"0",cursor:"se-resize"}),e.appendChild(t),t.addEventListener("mousedown",n=>{n.stopPropagation();const s=n.clientX,i=n.clientY,o=parseInt(document.defaultView.getComputedStyle(e).width,10),r=parseInt(document.defaultView.getComputedStyle(e).height,10),a=l=>{e.style.width=`${o+l.clientX-s}px`,e.style.height=`${r+l.clientY-i}px`},c=()=>{document.documentElement.removeEventListener("mousemove",a),document.documentElement.removeEventListener("mouseup",c)};document.documentElement.addEventListener("mousemove",a),document.documentElement.addEventListener("mouseup",c)})}}class O{constructor(e,t,n,s,i,o){this.wm=e,this.fs=t,this.musicPlayer=n,this.explorerApp=s,this.terminalApp=i,this.notepadApp=o,this.appMap={return:{type:"system",action:()=>window.location.href="/"},explorer:{type:"system",action:()=>this.explorerApp.open()},computer:{type:"system",action:()=>this.explorerApp.open()},terminal:{type:"system",action:()=>this.terminalApp.open()},notepad:{type:"system",action:()=>this.notepadApp.open()},music:{type:"system",action:()=>this.musicPlayer.open(this.wm)},sonic:{type:"swf",swf:"https://reeyuki.github.io/static/sonic.swf"},swarmQueen:{type:"swf",swf:"https://reeyuki.github.io/static/swarmQueen.swf"},pacman:{type:"game",url:"https://pacman-e281c.firebaseapp.com"},pvz:{type:"game",url:"https://emupedia.net/emupedia-game-pvz"},tetris:{type:"game",url:"https://turbowarp.org/embed.html?autoplay#31651654"},roads:{type:"game",url:"https://slowroads.io"},vscode:{type:"game",url:"https://emupedia.net/emupedia-app-vscode"},isaac:{type:"game",url:"https://emupedia.net/emupedia-game-binding-of-isaac"},mario:{type:"game",url:"https://emupedia.net/emupedia-game-mario"},papaGames:{type:"game",url:"https://papasgamesfree.io"},zombieTd:{type:"game",url:"https://www.gamesflow.com/jeux.php?id=2061391"},zombotron:{type:"game",url:"https://www.gameflare.com/embed/zombotron"},zombotron2:{type:"game",url:"https://www.gameflare.com/embed/zombotron-2"},fancyPants:{type:"game",url:"https://www.friv.com/z/games/fancypantsadventure/game.html"},fancyPants2:{type:"game",url:"https://www.friv.com/z/games/fancypantsadventure2/game.html"},strikeForce:{type:"game",url:"https://www.friv.com/z/games/strikeforcekitty/game.html"},jojo:{type:"game",url:"https://www.retrogames.cc/embed/8843-jojos-bizarre-adventure%3A-heritage-for-the-future-jojo-no-kimyou-na-bouken%3A-mirai-e-no-isan-japan-990927-no-cd.html"},gtaVc:{type:"game",url:"/static/vciframe.html"},pokemonRed:{type:"gba",url:"pokemon-red.gba"},pokemonEmerald:{type:"gba",url:"pokemon-emerald.gba"},pokemonPlatinum:{type:"nds",url:"pokemon-platinum.nds"},pokemonHeartgold:{type:"nds",url:"https://files.catbox.moe/xntjzl.nds"},pokemonWhite:{type:"nds",url:"https://files.catbox.moe/dcicfh.nds"}},this.emulatorBlacklist=["pokemonPlatinum.nds","pokemonHeartgold.nds","gtaVc","sonic"],z(this)}launch(e){const t=this.appMap[e];if(t)switch(t.type){case"system":t.action();break;case"swf":this.openRuffleApp(e,t.swf);break;case"gba":this.openEmulatorApp(e,t.url,"gba");break;case"nds":this.openEmulatorApp(e,t.url,"nds");break;case"game":this.openGameApp(e,t.url);break}}isBlacklisted(e){return location.hostname!=="reeyuki.neocities.org"?!1:this.emulatorBlacklist.includes(e)}openRuffleApp(e,t){if(this.isBlacklisted(e)){this.showCannotLoadPopup();return}const n=t.replace(/[^a-zA-Z0-9]/g,"");if(document.getElementById(`${n}-win`)){this.wm.bringToFront(document.getElementById(`${n}-win`));return}const s=`<embed src="${t}" width="100%" height="100%">`;this.createWindow(n,e.toUpperCase(),s)}openEmulatorApp(e,t,n){if(this.isBlacklisted(e)){this.showCannotLoadPopup();return}const s=`${n}-${t.replace(/\W/g,"")}-${Date.now()}`;if(document.getElementById(s)){this.wm.bringToFront(document.getElementById(s));return}const i=`/static/emulatorjs.html?rom=${encodeURIComponent(t)}&core=${encodeURIComponent(n)}&color=%230064ff`,o=`
      <iframe src="${i}"
              id="${s}-iframe"
              style="width:100%; height:100%; border:none;"
              allow="autoplay; fullscreen; clipboard-write; encrypted-media; picture-in-picture"
              sandbox="allow-forms allow-downloads allow-modals allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation">
      </iframe>
    `,r=t.replace(/\..+$/,"");this.createWindow(s,r,o,i)}openGameApp(e,t){if(this.isBlacklisted(e)){this.showCannotLoadPopup();return}if(document.getElementById(`${e}-win`)){this.wm.bringToFront(document.getElementById(`${e}-win`));return}const n=`
      <iframe src="${t}" 
              style="width:100%; height:100%; border:none;" 
              allow="autoplay; fullscreen; clipboard-write; encrypted-media; picture-in-picture"
              sandbox="allow-forms allow-downloads allow-modals allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation">
      </iframe>
    `,s=e.replace(/([A-Z])/g," $1").replace(/^./,i=>i.toUpperCase());this.createWindow(e,s,n,t)}showCannotLoadPopup(){const e=document.createElement("div");e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.background="#fff",e.style.border="1px solid #ccc",e.style.padding="15px",e.style.borderRadius="5px",e.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)",e.style.zIndex=9999,e.innerHTML=`
      <strong>Cannot Load Game</strong><br>
      Neocities hosting does not allow loading game assets from different domains. To play this game, use GitHub:<br>
      <a href="https://reeyuki.github.io/desktop/" target="_blank">https://reeyuki.github.io/desktop/</a><br>
      <button id="closePopup" style="margin-top:10px;">Close</button>
    `,document.body.appendChild(e),document.getElementById("closePopup").addEventListener("click",()=>e.remove())}createWindow(e,t,n,s=null){const i=this.wm.createWindow(`${e}-win`,t);i.innerHTML=`
      <div class="window-header">
        <span>${t}</span>
        <div class="window-controls">
          <button class="minimize-btn" title="Minimize">−</button>
          ${s?'<button class="external-btn" title="Open in External">↗</button>':""}
          <button class="maximize-btn" title="Maximize">□</button>
          <button class="close-btn" title="Close">X</button>
        </div>
      </div>
      <div class="window-content" style="width:100%; height:100%;">
        ${n}
      </div>
    `,desktop.appendChild(i),this.wm.makeDraggable(i),this.wm.makeResizable(i),this.wm.setupWindowControls(i),s&&i.querySelector(".external-btn").addEventListener("click",()=>window.open(s,"_blank")),this.wm.addToTaskbar(i.id,t)}}function z(f){const e={system:document.querySelector('.kde-page[data-page="system"]'),apps:document.querySelector('.kde-page[data-page="apps"]'),games:document.querySelector('.kde-page[data-page="games"]'),favorites:document.querySelector('.kde-page[data-page="favorites"]')};["system","apps","games"].forEach(t=>{e[t]&&(e[t].innerHTML="")}),Object.entries(f.appMap).forEach(([t,n])=>{const s=document.createElement("div");s.classList.add("kde-item"),s.dataset.app=t;const i=t.charAt(0).toUpperCase()+t.slice(1);s.textContent=i,s.addEventListener("click",()=>f.launch(t)),n.type==="system"?e.system?.appendChild(s):n.type==="game"||n.type==="swf"?e.games?.appendChild(s):e.apps?.appendChild(s)})}class W{constructor(e,t){this.fs=e,this.wm=t}setExplorer(e){this.explorerApp=e}open(e="Untitled",t="",n=null){const s=`notepad-${e.replace(/\s/g,"")}`;if(document.getElementById(s)){this.wm.bringToFront(document.getElementById(s));return}const i=this.wm.createWindow(s,`${e} - Notepad`,"600px","400px");Object.assign(i.style,{left:"250px",top:"150px"}),i.innerHTML=`
      <div class="window-header">
        <span>${e} - Notepad</span>
        <div class="window-controls">
          <button class="minimize-btn" title="Minimize">−</button>
          <button class="maximize-btn" title="Maximize">□</button>
          <button class="close-btn" title="Close">X</button>
        </div>
      </div>
      <div class="notepad-menu">
        <button class="notepad-btn" data-action="save">Save</button>
        <button class="notepad-btn" data-action="saveAs">Save As</button>
        <button class="notepad-btn" data-action="open">Open</button>
      </div>
      <div class="window-content">
        <textarea class="notepad-textarea" style="width:100%; height:calc(100% - 40px); border:none; padding:10px; font-family:monospace;">${t}</textarea>
      </div>
    `,desktop.appendChild(i),this.wm.makeDraggable(i),this.wm.makeResizable(i),this.wm.setupWindowControls(i),this.wm.addToTaskbar(i.id,`${e} - Notepad`),this.setupNotepadControls(i,e,n)}setupNotepadControls(e,t,n){const s=e.querySelector(".notepad-textarea");e.querySelectorAll(".notepad-btn").forEach(o=>{o.onclick=()=>{const r=o.dataset.action;r==="save"?this.saveFile(e,s,t,n):r==="saveAs"?this.saveAsFile(s):r==="open"&&this.openFileDialog()}})}saveFile(e,t,n,s){if(!s){this.saveAsFile(t);return}const i=t.value;this.fs.updateFile(s,n,i),alert(`File saved: ${n}`)}saveAsFile(e){const t=prompt("Enter file name:","NewFile.txt");if(!t)return;const n=prompt("Enter path (e.g., home/reeyuki/Documents):","home/reeyuki/Documents");if(!n)return;const s=n.split("/").filter(o=>o),i=e.value;try{this.fs.createFile(s,t,i),alert(`File saved: ${t} at /${n}`)}catch{alert("Error saving file. Please check the path.")}}openFileDialog(){this.explorerApp.open((e,t)=>{const n=this.fs.getFileContent(e,t);this.open(t,n,e)})}}const F={home:{reeyuki:{Documents:{"INFO.txt":{type:"file",content:"Files you saved in notepad gets saved in your browser session.",kind:g.TEXT}},Pictures:{"wallpaper1.webp":{type:"file",content:"/static/wallpapers/wallpaper1.webp",kind:g.IMAGE},"wallpaper2.webp":{type:"file",content:"/static/wallpapers/wallpaper2.webp",kind:g.IMAGE},"wallpaper3.webp":{type:"file",content:"/static/wallpapers/wallpaper3.webp",kind:g.IMAGE},"wallpaper4.webp":{type:"file",content:"/static/wallpapers/wallpaper4.webp",kind:g.IMAGE},"wallpaper5.webp":{type:"file",content:"/static/wallpapers/wallpaper5.webp",kind:g.IMAGE},"wallpaper6.webp":{type:"file",content:"/static/wallpapers/wallpaper6.webp",kind:g.IMAGE}},Music:{}}}},P={STORAGE_KEY:"desktopOS_fileSystem"};class D{constructor(){this.loadFromStorage()}loadFromStorage(){const e=localStorage.getItem(P.STORAGE_KEY);this.fileSystem=e?JSON.parse(e):F}saveToStorage(){localStorage.setItem(P.STORAGE_KEY,JSON.stringify(this.fileSystem))}normalizePath(e){return typeof e=="string"?e.split("/").filter(t=>t):Array.isArray(e)?e.filter(t=>t):[]}resolvePath(e,t=[]){if(typeof e=="string"){if(e.startsWith("/"))return this.normalizePath(e);const n=[...t];return e.split("/").filter(s=>s).forEach(s=>{s===".."?n.pop():s!=="."&&n.push(s)}),n}return this.normalizePath(e)}getFolder(e){return this.normalizePath(e).reduce((n,s)=>{if(!n||typeof n!="object")throw new Error(`Invalid path: cannot access ${s}`);return n[s]},this.fileSystem)}inferKind(e){const t=e.split(".").pop().toLowerCase();return["png","jpg","jpeg","gif","webp"].includes(t)?g.IMAGE:["txt","js","json","md","html","css"].includes(t)?g.TEXT:"generic"}createFile(e,t,n=""){const s=this.getFolder(e),i=this.inferKind(t);s[t]={type:"file",content:n,kind:i},this.saveToStorage()}createFolder(e,t){const n=this.getFolder(e);n[t]={},this.saveToStorage()}deleteItem(e,t){const n=this.getFolder(e);delete n[t],this.saveToStorage()}renameItem(e,t,n){const s=this.getFolder(e);s[n]=s[t],delete s[t],this.saveToStorage()}updateFile(e,t,n){const s=this.getFolder(e),i=s[t];if(i&&i.type==="file")i.content=n;else{const o=this.inferKind(t);s[t]={type:"file",content:n,kind:o}}this.saveToStorage()}getFileContent(e,t){const s=this.getFolder(e)[t];return s&&s.type==="file"&&s.content||""}getFileKind(e,t){const s=this.getFolder(e)[t];return console.log(s),s&&s.type==="file"?s.kind||"generic":null}isFile(e,t){const s=this.getFolder(e)[t];return s&&s.type==="file"}}class j{constructor(){}open(e){if(document.getElementById("music-win")){console.log("bringing window to front"),e.bringToFront(document.getElementById("music-win"));return}console.log("Creating window");const t=e.createWindow("music-win","MUSIC");t.innerHTML=`
  <div class="window-header">
    <span>MUSIC</span>
    <div class="window-controls">
      <button class="minimize-btn" title="Minimize">−</button>
      <button class="maximize-btn" title="Maximize">□</button>
      <button class="close-btn" title="Close">X</button>
    </div>
  </div>
  <div class="window-content" style="width:100%; height:100%;">
    <div id="player-container" style="display:flex; flex-direction:column; align-items:center; gap:10px; padding:10px;"></div>
    </div>
  </div>`,q.appendChild(t),y.renderMusicPage(document.getElementById("player-container")),e.makeDraggable(t),e.makeResizable(t),e.setupWindowControls(t),e.addToTaskbar(t.id,"MUSIC")}}class R{constructor(e){this.appLauncher=e,this.desktop=document.getElementById("desktop"),this.startButton=document.getElementById("start-button"),this.startMenu=document.getElementById("start-menu"),this.contextMenu=document.getElementById("context-menu"),this.selectionBox=document.getElementById("selection-box"),this.setupEventListeners()}setupEventListeners(){this.startButton.addEventListener("click",e=>{e.stopPropagation(),this.startMenu.style.display=this.startMenu.style.display==="flex"?"none":"flex"}),this.startMenu.addEventListener("click",e=>{e.stopPropagation()}),document.addEventListener("click",()=>{this.startMenu.style.display="none",this.contextMenu.style.display="none"}),this.desktop.addEventListener("contextmenu",e=>{e.target===this.desktop&&(e.preventDefault(),this.showDesktopContextMenu(e))}),this.setupIconHandlers(),this.setupSelectionBox(),this.setupStartMenu()}setupIconHandlers(){document.querySelectorAll(".icon.selectable").forEach(e=>{Object.assign(e.style,{userSelect:"none",webkitUserDrag:"none"}),e.draggable=!1,e.addEventListener("dblclick",t=>{t.stopPropagation();const n=e.dataset.app;n&&this.appLauncher.launch(n,e)}),e.addEventListener("mousedown",t=>{t.stopPropagation()})})}showDesktopContextMenu(e){this.contextMenu.innerHTML=' <div id="ctx-new-notepad">New Notepad</div>       <div id="ctx-open-explorer">Open File Explorer</div>       <hr>       <div id="ctx-refresh">Refresh</div>       <hr>    ;',document.getElementById("ctx-new-notepad").onclick=()=>{this.contextMenu.style.display="none",b.open()},document.getElementById("ctx-open-explorer").onclick=()=>{this.contextMenu.style.display="none",y.open()},document.getElementById("ctx-refresh").onclick=()=>{this.contextMenu.style.display="none",location.reload()},Object.assign(this.contextMenu.style,{left:`${e.pageX}px`,top:`${e.pageY}px`,display:"block"})}setupSelectionBox(){const e=document.querySelectorAll(".selectable");let t,n;this.desktop.addEventListener("mousedown",s=>{if(s.target!==this.desktop)return;t=s.pageX,n=s.pageY,Object.assign(this.selectionBox.style,{left:`${t}px`,top:`${n}px`,width:"0px",height:"0px",display:"block"}),e.forEach(r=>r.classList.remove("selected"));const i=r=>{const a=Math.abs(r.pageX-t),c=Math.abs(r.pageY-n),l=Math.min(r.pageX,t),p=Math.min(r.pageY,n);Object.assign(this.selectionBox.style,{width:`${a}px`,height:`${c}px`,left:`${l}px`,top:`${p}px`});const m=this.selectionBox.getBoundingClientRect();e.forEach(h=>{const u=h.getBoundingClientRect();!(u.right<m.left||u.left>m.right||u.bottom<m.top||u.top>m.bottom)?h.classList.add("selected"):h.classList.remove("selected")})},o=()=>{this.selectionBox.style.display="none",document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",o)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",o)})}setupStartMenu(){this.startMenu.querySelectorAll(".start-item").forEach(e=>{e.onclick=t=>{t.stopPropagation();const n=e.dataset.app;n==="documents"?(y.open(),y.navigate(["home","reeyuki","Documents"])):n==="pictures"?(y.open(),y.navigate(["home","reeyuki","Pictures"])):n==="notes"&&b.open(),this.startMenu.style.display="none"}})}}class M{static startClock(){const e=()=>{const t=new Date;document.getElementById("clock").textContent=t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),document.getElementById("date").textContent=t.toLocaleDateString()};setInterval(e,1e3),e()}static setRandomWallpaper(){const e=F.home.reeyuki.Pictures,t=Object.values(e).filter(s=>s.kind==="image").map(s=>s.content);if(!t.length)return;const n=t[Math.floor(Math.random()*t.length)];document.body.style.background=`url('${n}') no-repeat center center fixed`,document.body.style.backgroundSize="cover"}}const q=document.getElementById("desktop"),x=new D,k=new B,b=new W(x,k,null),y=new A(x,k,b);b.setExplorer(y);const U=new L(x,k),H=new j,$=new O(k,x,H,y,U,b);new R($);M.startClock();M.setRandomWallpaper();const G=window.location.search,N=new URLSearchParams(G),I=N.get("game");I&&setTimeout(()=>{$.launch(I)},100);
