import{B as W,i as A,l as Q,p as L,g as tt,a as et}from"./vendor--MsaxDnK.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const x=document.getElementById("desktop");class st{constructor(t,e){this.fs=t,this.wm=e,this.currentPath=["home","reeyuki"],this.history=[],this.historyIndex=-1,this.username="reeyuki",this.hostname="desktop-os",this.printQueue=Promise.resolve(),this.commands={},this.pageLoadTime=Date.now(),this.isPrinting=!1,this.inputBuffer="",this.printDepth=0,this.registerDefaultCommands()}async print(t,e=null,s=!1,i=null,n=30){this.printDepth++,this.printDepth===1&&(this.isPrinting=!0,this.inputBuffer=this.terminalInput.value,this.terminalInput.value="",this.terminalInputLine.style.display="none");const o=document.createElement("div"),a=document.createElement("span");if(s){const r=document.createElement("span");r.textContent=i||this.terminalPrompt.textContent,r.style.color="white",o.appendChild(r),o.appendChild(a)}else e&&(a.style.color=e),o.appendChild(a);this.terminalOutput.appendChild(o);for(let r=0;r<t.length;r++)a.textContent+=t[r],await new Promise(l=>setTimeout(l,n)),this.terminalOutput.parentElement.scrollTop=this.terminalOutput.parentElement.scrollHeight;this.printDepth--,this.printDepth===0&&(this.isPrinting=!1,this.terminalInputLine.style.display="flex",this.terminalInput.value=this.inputBuffer,this.terminalInput.focus())}enqueuePrint(t,e=null,s=!1,i=null,n=6){return this.printQueue=this.printQueue.then(()=>this.print(t,e,s,i,n)),this.printQueue}setupEventHandlers(){this.terminalInput.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();const s=this.terminalInput.value.trim();if(!s)return;this.history.push(s),this.historyIndex=this.history.length,this.terminalInput.value="",this.executeCommand(s)}else if(e.key==="ArrowUp"&&this.historyIndex>0)e.preventDefault(),this.terminalInput.value=this.history[--this.historyIndex];else if(e.key==="ArrowDown")e.preventDefault(),this.historyIndex=Math.min(this.historyIndex+1,this.history.length),this.terminalInput.value=this.historyIndex<this.history.length?this.history[this.historyIndex]:"";else if(e.key==="Tab")e.preventDefault(),this.handleTabCompletion();else if(e.ctrlKey&&e.key==="l")e.preventDefault(),this.cmdClear();else if(e.ctrlKey&&e.key==="c"){const s=window.getSelection();if(s&&s.toString().length>0)return;e.preventDefault(),this.enqueuePrint("^C","white",!0,this.terminalPrompt.textContent),this.terminalInput.value=""}else if(e.ctrlKey&&e.key==="d"){const s=window.getSelection();if(s&&s.toString().length>0||this.terminalInput.value.length>0)return;e.preventDefault();const i=document.getElementById("terminal-win");this.wm.removeFromTaskbar(i.id),i&&i.remove();return}});const t=document.getElementById("terminal-win");t.addEventListener("mousedown",()=>{const e=window.getSelection();e&&e.removeAllRanges()}),t.addEventListener("mouseup",()=>{window.getSelection().toString().length>0||this.terminalInput.focus()})}expandGlob(t,e){const s=Object.keys(this.fs.getFolder(e)),i=new RegExp("^"+t.replace(/\*/g,".*").replace(/\?/g,".")+"$");return s.filter(n=>i.test(n))}expandGlobsInArgs(t,e){const s=[];for(const i of t)if(i.includes("*")||i.includes("?")){const n=this.expandGlob(i,e);n.length>0?s.push(...n):s.push(i)}else s.push(i);return s}parseCommand(t){return t.split("|").map(s=>s.trim()).map(s=>{const n=(s.match(/(?:[^\s"]+|"[^"]*")+/g)||[]).map(l=>l.replace(/^"(.*)"$/,"$1")),o=n[0],a=[],r=[];for(let l=1;l<n.length;l++)n[l].startsWith("-")?r.push(n[l]):a.push(n[l]);return{command:o,args:a,flags:r}})}async executePipeline(t){let e=null;for(let s=0;s<t.length;s++){const{command:i,args:n,flags:o}=t[s],a=this.expandGlobsInArgs(n,this.currentPath);e!==null&&a.unshift(e);const r=this.commands[i];if(!r){i&&await this.enqueuePrint(`bash: ${i}: command not found`);return}s<t.length-1?e=await this.captureOutput(()=>r(a,o)):await r(a,o)}}async captureOutput(t){const e=this.print.bind(this),s=[];return this.print=async i=>{s.push(i)},await t(),await this.printQueue,this.print=e,s.join(`
`)}async executeCommand(t){await this.enqueuePrint(t,null,!0,this.terminalPrompt.textContent);const e=this.parseCommand(t);await this.executePipeline(e),this.updatePrompt()}handleTabCompletion(){const t=this.terminalInput.value,e=this.terminalInput.selectionStart,s=t.slice(0,e),i=s.match(/(\S+)$/);if(!i)return;const n=i[1],o=s.slice(0,s.length-n.length);let a,r;if(n.includes("/")){const p=n.split("/");r=p.pop(),a=this.fs.resolvePath(p.join("/"),this.currentPath)}else a=[...this.currentPath],r=n;let l;try{l=Object.keys(this.fs.getFolder(a))}catch{return}const d=l.filter(p=>p.startsWith(r));if(d.length)if(d.length===1){const p=d[0]+(this.fs.isFile(a,d[0])?"":"/");this.terminalInput.value=o+p+t.slice(e),this.terminalInput.selectionStart=this.terminalInput.selectionEnd=o.length+p.length}else{const p=d.reduce((f,w)=>{let m=0;for(;m<f.length&&m<w.length&&f[m]===w[m];)m++;return f.slice(0,m)},d[0]);p.length>r.length?(this.terminalInput.value=o+p+t.slice(e),this.terminalInput.selectionStart=this.terminalInput.selectionEnd=o.length+p.length):this.print(d.join("  "))}}open(){const t=document.getElementById("terminal-win");if(t)return this.wm.bringToFront(t);const e=this.wm.createWindow("terminal-win","Terminal","700px","500px");Object.assign(e.style,{left:"200px",top:"100px"}),e.innerHTML=`
    <div class="window-header">
      <span>Terminal</span>
      <div class="window-controls">
        <button class="minimize-btn">−</button>
        <button class="maximize-btn">□</button>
        <button class="close-btn">X</button>
      </div>
    </div>
    <div class="window-content" style="background:#000;color:white;font-family:monospace;padding:10px;overflow-y:auto;height:calc(100% - 40px);">
      <div id="terminal-output" style="white-space:pre;"></div>
      <div id="terminal-input-line" style="display:flex;">
        <span id="terminal-prompt"></span>
        <input id="terminal-input" style="flex:1;background:transparent;border:none;color:white;font-family:monospace;outline:none;margin-left:5px;">
      </div>
    </div>
  `,x.appendChild(e),this.wm.makeDraggable(e),this.wm.makeResizable(e),this.wm.setupWindowControls(e),this.wm.addToTaskbar(e.id,"Terminal","/static/icons/terminal.png"),this.terminalOutput=e.querySelector("#terminal-output"),this.terminalInput=e.querySelector("#terminal-input"),this.terminalPrompt=e.querySelector("#terminal-prompt"),this.terminalInputLine=e.querySelector("#terminal-input-line"),this.terminalOutput.addEventListener("contextmenu",s=>{s.stopPropagation()}),this.terminalOutput.style.userSelect="text",this.terminalInput.style.userSelect="text",this.updatePrompt(),this.print("Welcome to Reeyuki's terminal"),this.print(`Type 'help' for available commands
`),this.setupEventHandlers(),this.terminalInput.focus()}updatePrompt(){const t=this.currentPath.length?"/"+this.currentPath.join("/"):"/";this.terminalPrompt.textContent=`${this.username}@${this.hostname}:${t}$ `}registerCommand(t,e){this.commands[t]=e}registerDefaultCommands(){this.registerCommand("help",()=>this.cmdHelp()),this.registerCommand("clear",()=>this.cmdClear()),this.registerCommand("pwd",()=>this.print(this.currentPath.length?"/"+this.currentPath.join("/"):"/")),this.registerCommand("ls",(t,e)=>this.cmdLs(t,e)),this.registerCommand("cd",t=>this.cmdCd(t)),this.registerCommand("mkdir",t=>this.cmdMkdir(t)),this.registerCommand("touch",t=>this.cmdTouch(t)),this.registerCommand("rm",(t,e)=>this.cmdRm(t,e)),this.registerCommand("cat",t=>this.cmdCat(t)),this.registerCommand("echo",t=>this.print(t.join(" "))),this.registerCommand("whoami",()=>this.print(this.username)),this.registerCommand("hostname",()=>this.print(this.hostname)),this.registerCommand("date",()=>this.print(new Date().toString())),this.registerCommand("history",()=>this.history.forEach((t,e)=>this.print(`  ${e+1}  ${t}`))),this.registerCommand("tree",()=>this.cmdTree()),this.registerCommand("uname",()=>this.print("Linux reeyuki-desktop 6.1.23-arch1-1 #1 SMP PREEMPT x86_64 GNU/Linux")),this.registerCommand("ping",t=>this.cmdPing(t)),this.registerCommand("curl",t=>this.cmdCurl(t)),this.registerCommand("neofetch",()=>this.cmdNeofetch()),this.registerCommand("ps",()=>this.cmdPs()),this.registerCommand("grep",t=>this.cmdGrep(t)),this.registerCommand("wc",t=>this.cmdWc(t))}cmdClear(){this.terminalOutput.innerHTML=""}cmdLs(t=[],e=[]){const s=e.some(p=>p.includes("a")),i=e.some(p=>p.includes("l")),n=e.some(p=>p.includes("h")),o=e.some(p=>p.includes("R")),a=e.some(p=>p.includes("r")),r=p=>{if(!n)return p;const f=["B","K","M","G"];let w=0,m=p;for(;m>=1024&&w<f.length-1;)m/=1024,w++;return`${Math.round(m)}${f[w]}`},l=(p,f="")=>{try{const w=this.fs.getFolder(p);let m=Object.keys(w);s||(m=m.filter(u=>!u.startsWith("."))),a&&(m=m.reverse()),m.forEach(u=>{const g=this.fs.isFile(p,u),h=i?`${g?"-":"d"} ${u}${g?"":"/"}${g&&w[u].size!=null?` ${r(w[u].size)}`:""}`:u+(g?"":"/");this.print(f+h,g?null:"blue"),o&&!g&&l(this.fs.resolvePath(u,p),f+"  ")})}catch{this.print(`ls: cannot access '${p}': No such file or directory`)}},d=t.length?this.fs.resolvePath(t[0],this.currentPath):this.currentPath;l(d)}cmdCd(t){if(!t.length||t[0]==="~"){this.currentPath=["home",this.username];return}try{const e=this.fs.resolvePath(t[0],this.currentPath);this.fs.getFolder(e),this.currentPath=e}catch{this.print(`cd: ${t[0]}: No such file or directory`)}}cmdMkdir(t){if(!t.length)return this.print("mkdir: missing operand");t.forEach(e=>{this.fs.createFolder(this.currentPath,e),this.print(`Created directory: ${e}`)})}cmdTouch(t){if(!t.length)return this.print("touch: missing file operand");t.forEach(e=>{this.fs.createFile(this.currentPath,e,""),this.print(`Created file: ${e}`)})}cmdRm(t=[],e=[]){if(!t.length)return this.print("rm: missing operand");const s=e.some(o=>o.includes("r")),i=e.some(o=>o.includes("f")),n=o=>{try{const a=o.slice(0,-1),r=o[o.length-1];if(this.fs.isFile(a,r))this.fs.deleteItem(a,r);else{if(!s)throw new Error("is a directory");Object.keys(this.fs.getFolder(o)).forEach(d=>n([...o,d])),this.fs.deleteItem(a,r)}}catch(a){i||this.print(`rm: cannot remove '${o.join("/")}': ${a.message}`)}};t.forEach(o=>{let a=o.startsWith("/")?this.fs.resolvePath(o,[]):this.fs.resolvePath(o,this.currentPath);n(a)})}cmdCat(t){if(!t.length)return this.print("cat: missing file operand");t.forEach(e=>{e.includes(`
`)?this.print(e):this.fs.isFile(this.currentPath,e)?this.print(this.fs.getFileContent(this.currentPath,e)||"(empty file)"):this.print(`cat: ${e}: Is a directory`)})}cmdGrep(t){if(t.length<1)return this.print("grep: missing pattern");const e=t[0],i=t.slice(1).join(" ").split(`
`),n=new RegExp(e,"i");i.forEach(o=>{n.test(o)&&this.print(o)})}cmdWc(t){const e=t.join(" "),s=e.split(`
`).filter(o=>o.length>0),i=e.split(/\s+/).filter(o=>o.length>0),n=e.length;this.print(`  ${s.length}  ${i.length}  ${n}`)}cmdTree(t=this.currentPath,e=""){e||this.print(t.length?"/"+t.join("/"):"/");const s=Object.keys(this.fs.getFolder(t));s.forEach((i,n)=>{const o=this.fs.isFile(t,i),a=n===s.length-1;this.print(e+(a?"└── ":"├── ")+i+(o?"":"/")),o||this.cmdTree([...t,i],e+(a?"    ":"│   "))})}async cmdPing(t){if(!t.length)return this.print("Usage: ping <host>");await this.print(`PING ${t[0]} ...`);const e=performance.now();try{await fetch("https://"+t[0],{method:"HEAD",mode:"no-cors"})}catch(s){console.error(s)}await this.print(`Reply from ${t[0]}: time=${(performance.now()-e).toFixed(2)}ms`)}async cmdCurl(t){if(!t.length)return this.print("Usage: curl <url>");try{const e=await(await fetch(t[0])).text();this.print(e.slice(0,1e3))}catch{this.print(`curl: (6) Could not resolve host: ${t[0]}`)}}async cmdNeofetch(){const t=navigator.userAgent,e=navigator.userAgentData?.platform||navigator.platform||t||"Unknown";let s="Unknown";/Windows/i.test(e)?s="Windows":/Mac/i.test(e)?s="macOS":/Android/i.test(e)?s="Android":/iPhone|iPad|iOS/i.test(e)?s="iOS":/Linux/i.test(e)&&(s="Linux");const i=s==="Windows"?"Eww a windows!":s;let n="Unknown";/Firefox\/\d+/i.test(t)?n="Firefox":/Edg\/\d+/i.test(t)?n="Edge":/Chrome\/\d+/i.test(t)?n="Chrome":/Safari\/\d+/i.test(t)&&(n="Safari");const o=n==="Chrome"||n==="Edge"?"eww a chromium?!":n,a=navigator.hardwareConcurrency??"Unknown",r=typeof a=="number"&&a>10?`${a} (WOW ITS SO BIG!)`:a;let l="Unknown",d=0;try{const h=document.createElement("canvas"),b=h.getContext("webgl2")||h.getContext("webgl");if(b){l=b.getParameter(b.RENDERER);const T=b.getParameter(b.MAX_TEXTURE_SIZE),E=b.getParameter(b.MAX_VARYING_VECTORS),C=b.getParameter(b.MAX_VERTEX_UNIFORM_VECTORS);d=Math.min(8,Math.floor((T/2048+E/16+C/128)*1.2))}}catch(h){console.error(h)}let p="Unknown";typeof InstallTrigger<"u"?p="SpiderMonkey":typeof window.chrome<"u"?p="V8":/Apple/.test(navigator.vendor)&&(p="JavaScriptCore");const f=navigator.deviceMemory?`${navigator.deviceMemory} GB`:"Unknown",w=navigator.doNotTrack==="1"||window.doNotTrack==="1"?"Enabled":"Disabled",m=Date.now()-this.pageLoadTime,u=`${Math.floor(m/36e5)}h, ${Math.floor(m%36e5/6e4)}m`,g=["","","                     "+this.username+"@"+this.hostname,`        /\\           OWOS     ${i}`,`       /  \\          KEWNEL   ${p}wu`,`      /\\   \\         CPUWU    Cwpu Cowes: ${r}`,`     / > ω <\\        BROWSEWU  ${o}`,`    /   __   \\       GWAPHU    ${l}`,`   / __|  |__-\\      WENDAWU   ${d}`,`  /_-''    ''-_\\     MEMOWY    ${f}`,`                     DoNawtTWACKWU  ${w}`,`                     RESOWUW   ${window.innerWidth}x${window.innerHeight}`,`                     UWUPTIME  ${u}`];for(const h of g)await this.enqueuePrint(h)}cmdPs(){const t=Array.from(document.querySelectorAll(".window"));this.print("  PID   TTY      TIME CMD"),t.forEach((e,s)=>{const i=e.querySelector(".window-header span")?.textContent||"unknown";this.print(`  ${1e3+s}  pts/0  0:00 ${i}`)})}cmdHelp(){const t=[["help","Show this help message"],["neofetch","Display system/browser summary"],["clear","Clear the terminal screen"],["ls","List directory contents"],["pwd","Print working directory"],["cd [dir]","Change directory"],["mkdir","Create a new directory"],["touch","Create a new file"],["rm","Remove file or directory"],["cat","Display file contents"],["echo","Display a line of text"],["grep","Search for pattern in input"],["wc","Count lines, words, and characters"],["whoami","Display current user"],["hostname","Display hostname"],["date","Display current date and time"],["history","Show command history"],["tree","Display directory tree"]];this.print("Available commands:"),t.forEach(([e,s])=>this.print(`  ${e.padEnd(10)} - ${s}`)),this.print(""),this.print("Glob patterns: * (match any), ? (match one)"),this.print("Pipes: command1 | command2")}}const k={ROOT:"/home/reeyuki",META_FILE:".meta.json",LEGACY_KEY:"desktopOS_fileSystem"},y={IMAGE:"image",TEXT:"text",OTHER:"other"},q={home:{reeyuki:{Documents:{"INFO.txt":{type:"file",content:"Files you saved in notepad get saved in your browser session.",kind:y.TEXT,icon:"/static/icons/notepad.webp"}},Pictures:{"wallpaper1.webp":{type:"file",content:"/static/wallpapers/wallpaper1.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper1.webp"},"wallpaper2.webp":{type:"file",content:"/static/wallpapers/wallpaper2.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper2.webp"},"wallpaper3.webp":{type:"file",content:"/static/wallpapers/wallpaper3.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper3.webp"},"wallpaper4.webp":{type:"file",content:"/static/wallpapers/wallpaper4.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper4.webp"},"wallpaper5.webp":{type:"file",content:"/static/wallpapers/wallpaper5.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper5.webp"},"wallpaper6.webp":{type:"file",content:"/static/wallpapers/wallpaper6.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper6.webp"},"wallpaper7.webp":{type:"file",content:"/static/wallpapers/wallpaper7.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper7.webp"},"wallpaper8.webp":{type:"file",content:"/static/wallpapers/wallpaper8.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper8.webp"},"wallpaper9.webp":{type:"file",content:"/static/wallpapers/wallpaper9.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper9.webp"},"wallpaper10.webp":{type:"file",content:"/static/wallpapers/wallpaper10.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper10.webp"},"wallpaper11.webp":{type:"file",content:"/static/wallpapers/wallpaper11.webp",kind:y.IMAGE,icon:"/static/wallpapers/wallpaper11.webp"}},Music:{}}}};class it{constructor(){this.fsReady=this.initFS()}p(t,...e){return new Promise((s,i)=>{this.fs[t](...e,n=>n?i(n):s())})}pRead(t,...e){return new Promise((s,i)=>{this.fs[t](...e,(n,o)=>n?i(n):s(o))})}pStat(t){return new Promise((e,s)=>{this.fs.stat(t,(i,n)=>i?s(i):e(n))})}async initFS(){return new Promise(t=>{W.configure({fs:"IndexedDB",options:{}},async()=>{this.fs=W.BFSRequire("fs"),await this.migrateIfNeeded(),await this.ensureDefaults(),t()})})}async migrateIfNeeded(){if(await this.exists(k.ROOT)||!await this.exists(k.LEGACY_KEY))return;const s=await this.readFile(k.LEGACY_KEY),i=JSON.parse(s);await this.createFromObject(i,"/"),await this.p("unlink",k.LEGACY_KEY)}async ensureDefaults(){await this.createFromObject(q,"/")}async createFromObject(t,e){for(const s in t){const i=t[s],n=this.join(e,s);i.type==="file"?(await this.p("mkdir",this.dirname(n),{recursive:!0}).catch(()=>{}),await this.exists(n)||await this.p("writeFile",n,i.content??""),await this.writeMeta(this.dirname(n),s,i)):(await this.p("mkdir",n,{recursive:!0}).catch(()=>{}),await this.createFromObject(i,n))}}join(...t){return t.join("/").replace(/\/+/g,"/")}dirname(t){return t.split("/").slice(0,-1).join("/")||"/"}async readMeta(t){const e=this.join(t,k.META_FILE);try{const s=await this.pRead("readFile",e,"utf8");return JSON.parse(s)}catch{return{}}}async writeMeta(t,e,s){const i=this.join(t,k.META_FILE),n=await this.readMeta(t);n[e]={kind:s.kind,icon:s.icon},await this.p("writeFile",i,JSON.stringify(n))}async removeMeta(t,e){const s=this.join(t,k.META_FILE),i=await this.readMeta(t);delete i[e],await this.p("writeFile",s,JSON.stringify(i))}normalizePath(t){return typeof t=="string"?t.split("/").filter(Boolean):Array.isArray(t)?t.filter(Boolean):[]}resolvePath(t,e=[]){const s=typeof t=="string"?t.split("/"):[];let i=t.startsWith("/")?[]:[...e];for(const n of s)!n||n==="."||(n===".."?i.pop():i.push(n));return i}inferKind(t){const e=t.split(".").pop().toLowerCase();return["png","jpg","jpeg","gif","webp"].includes(e)?y.IMAGE:["txt","js","json","md","html","css"].includes(e)?y.TEXT:y.OTHER}resolveDir(t=[]){return typeof t=="string"&&(t=[t]),this.join("/",...k.ROOT.split("/").filter(Boolean),...this.normalizePath(t))}async ensureFolder(t){await this.fsReady;const e=this.resolveDir(t);await this.p("mkdir",e,{recursive:!0}).catch(()=>{})}async getFolder(t){await this.fsReady;const e=this.resolveDir(t);let s;try{s=await new Promise((o,a)=>{this.fs.readdir(e,(r,l)=>r?a(r):o(l))})}catch{throw new Error("Invalid path")}const i=await this.readMeta(e),n={};for(const o of s){if(o===k.META_FILE)continue;const a=this.join(e,o);if((await this.pStat(a)).isDirectory())n[o]={};else{const l=i[o]?.kind??this.inferKind(o),d=i[o]?.icon??"/static/icons/file.png";let p="";try{p=await this.pRead("readFile",a,"utf8")}catch(f){console.error(f)}n[o]={type:"file",kind:l,icon:d,content:p}}}return n}async createFile(t,e,s="",i=null,n=null){await this.fsReady;const o=this.resolveDir(t),a=this.join(o,e),r=i||this.inferKind(e),l=n||(r===y.TEXT?"/static/icons/notepad.webp":"/static/icons/file.png");await this.p("mkdir",o,{recursive:!0}).catch(()=>{}),await this.p("writeFile",a,s),await this.writeMeta(o,e,{kind:r,icon:l})}async createFolder(t,e){await this.fsReady;const s=this.join(this.resolveDir(t),e);await this.p("mkdir",s,{recursive:!0})}async deleteItem(t,e){await this.fsReady;const s=this.resolveDir(t),i=this.join(s,e);(await this.pStat(i)).isDirectory()?await this.deleteDirectoryRecursive(i):(await this.p("unlink",i),await this.removeMeta(s,e))}async deleteDirectoryRecursive(t){const e=await this.pRead("readdir",t);for(const s of e){const i=this.join(t,s);(await this.pStat(i)).isDirectory()?await this.deleteDirectoryRecursive(i):await this.p("unlink",i)}await this.p("rmdir",t)}async renameItem(t,e,s){await this.fsReady;const i=this.resolveDir(t);await this.p("rename",this.join(i,e),this.join(i,s));const n=await this.readMeta(i);n[e]&&(n[s]=n[e],delete n[e],await this.p("writeFile",this.join(i,k.META_FILE),JSON.stringify(n)))}async updateFile(t,e,s){await this.fsReady;const i=this.resolveDir(t),n=this.join(i,e);if(await this.exists(n))await this.p("writeFile",n,s);else{const a=this.inferKind(e),r=a===y.TEXT?"/static/icons/notepad.webp":"/static/icons/file.png";await this.createFile(t,e,s,a,r)}}async getFileContent(t,e){await this.fsReady;try{return await this.pRead("readFile",this.join(this.resolveDir(t),e),"utf8")}catch{return""}}async getFileKind(t,e){return await this.fsReady,(await this.readMeta(this.resolveDir(t)))[e]?.kind??null}async getFileIcon(t,e){return await this.fsReady,(await this.readMeta(this.resolveDir(t)))[e]?.icon??null}isFile(t,e){try{return this.fs.statSync(this.join(this.resolveDir(t),e)).isFile()}catch{return!1}}async writeFile(t,e){await this.p("writeFile",t,e)}async readFile(t){return await this.pRead("readFile",t,"utf8")}async exists(t){try{return await this.pStat(t),!0}catch{return!1}}}const O="desktopOS_selectedWallpaper";class D{static startClock(){const t=()=>{const e=new Date;document.getElementById("clock").textContent=e.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),document.getElementById("date").textContent=e.toLocaleDateString()};setInterval(t,1e3),t()}static setRandomWallpaper(){const t=q.home.reeyuki.Pictures,e=Object.values(t).filter(i=>i.kind==="image").map(i=>i.content);if(!e.length)return;const s=e[Math.floor(Math.random()*e.length)];this.setWallpaper(s)}static setWallpaper(t){let e=document.getElementById("wallpaper-img");e||(e=document.createElement("img"),e.id="wallpaper-img",Object.assign(e.style,{position:"fixed",inset:"0",width:"100vw",height:"100vh",objectFit:"cover",zIndex:"-1",pointerEvents:"none",userSelect:"none"}),e.addEventListener("contextmenu",s=>s.preventDefault()),document.body.appendChild(e)),e.src=t,localStorage.setItem(O,t)}static loadWallpaper(){const t=localStorage.getItem(O);t?this.setWallpaper(t):this.setRandomWallpaper()}}function nt(){const c={};return document.querySelectorAll("#desktop .icon.selectable").forEach(e=>{const s=e.dataset.app,i=e.querySelector("div").textContent,n=e.querySelector("img").src;c[s]={name:i,icon:n}}),c}const H=nt();function N(c){return c.replace(/(?:^\w|[A-Z]|\b\w)/g,function(t,e){return e===0?t.toLowerCase():t.toUpperCase()}).replace(/\s+/g,"")}const v=document.getElementById("context-menu");class ot{constructor(t,e,s){this.fs=t,this.wm=e,this.notepadApp=s,this.currentPath=[],this.history=[],this.historyIndex=-1,this.fileSelectCallback=null,this.open=this.open.bind(this)}async open(t=null){if(this.fileSelectCallback=t,document.getElementById("explorer-win")){this.wm.bringToFront(document.getElementById("explorer-win"));return}const e=document.createElement("div");e.className="window",e.id="explorer-win",e.dataset.fullscreen="false",e.innerHTML=`
      <div class="window-header">
        <span>File Explorer</span>
        ${this.wm.getWindowControls()}
      </div>
      <div class="explorer-nav">
        <div class="back-btn" id="exp-back">← Back</div>
        <div id="exp-path" style="color:#555"></div>
      </div>
      <div class="explorer-container">
        <div class="explorer-sidebar">
        <div class="start-item" data-path="">Home</div>
          <div class="start-item" data-path="Documents">Documents</div>
          <div class="start-item" data-path="Pictures">Pictures</div>
          <div class="start-item" data-path="Music">Music</div>
        </div>
        <div class="explorer-main" id="explorer-view"></div>
      </div>
    `,x.appendChild(e);const s=e.querySelector("#explorer-view");s.style.width="600px",this.wm.makeDraggable(e),this.wm.makeResizable(e),this.wm.setupWindowControls(e),setTimeout(()=>this.wm.bringToFront(e),0),this.wm.addToTaskbar(e.id,"File Explorer","/static/icons/file.png"),this.setupExplorerControls(e),this.navigate([])}setupExplorerControls(t){t.querySelector("#exp-back").onclick=async()=>{this.historyIndex>0&&(this.historyIndex--,this.currentPath=[...this.history[this.historyIndex]],await this.render())},t.querySelectorAll(".explorer-sidebar .start-item").forEach(s=>{s.onclick=async()=>{const i=s.dataset.path.split("/").filter(n=>n);this.navigate(i)}});const e=t.querySelector("#explorer-view");e.addEventListener("contextmenu",s=>{s.target===e&&this.showBackgroundContextMenu(s)})}navigate(t){return this.currentPath=[...t],this.history=this.history.slice(0,this.historyIndex+1),this.history.push([...this.currentPath]),this.historyIndex=this.history.length-1,this.render()}async renderMusicPage(t){t&&(t.innerHTML=`
      <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <iframe src="https://open.spotify.com/embed/playlist/6oK6F4LglYBr4mYLSRDJOa" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
        <iframe src="https://open.spotify.com/embed/playlist/1q7zv2ScwtR2jIxaIRj9iG" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
        <iframe src="https://open.spotify.com/embed/playlist/6q8mgrJZ5L4YxabVQoAZZf" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
      </div>
    `)}async render(){const t=document.getElementById("explorer-view"),e=document.getElementById("exp-path");if(!t)return;if(t.innerHTML="",e.textContent="/"+this.currentPath.join("/"),this.currentPath[this.currentPath.length-1]==="Music"){await this.renderMusicPage(t);return}const s=await this.fs.getFolder(this.currentPath);for(const[i,n]of Object.entries(s)){const o=n?.type==="file";let a;if(o){const l=i.split(".")[0],d=N(l);a=H[d]?.icon||"/static/icons/notepad.webp",console.log("basename: ",l," name : ",i," found result : ",a," camelized: ",d)}else a="/static/icons/file.png";const r=document.createElement("div");r.className="file-item",r.innerHTML=`
      <img src="${a}" style="width:64px;height:64px;object-fit:contain">
      <span>${i}</span>
    `,r.ondblclick=async()=>this.openItem(i,o),r.oncontextmenu=async l=>this.showFileContextMenu(l,i,o),t.appendChild(r)}}async openItem(t,e){if(e){if(this.fileSelectCallback){this.fileSelectCallback(this.currentPath,t),this.fileSelectCallback=null;return}const s=await this.fs.getFileContent(this.currentPath,t);await this.fs.getFileKind(this.currentPath,t)===y.IMAGE?this.openImageViewer(t,s):this.notepadApp.open(t,s,this.currentPath)}else this.navigate([...this.currentPath,t])}openImageViewer(t,e){const s=document.createElement("div");s.className="window",Object.assign(s.style,{width:"500px",height:"400px",left:"150px",top:"150px",zIndex:2e3}),s.innerHTML=`
      <div class="window-header">
        <span>${t}</span>
        ${this.wm.getWindowControls()}
      </div>
      <div style="display:flex;justify-content:center;align-items:center;height:calc(100% - 30px);background:#222">
        <img src="${e}" style="max-width:100%; max-height:100%">
      </div>
    `,x.appendChild(s),this.wm.makeDraggable(s),this.wm.makeResizable(s),this.wm.setupWindowControls(s),this.wm.addToTaskbar(s.id,t,"/static/icons/file.png")}async showFileContextMenu(t,e,s){t.preventDefault(),t.stopPropagation(),v.innerHTML="";const i=(a,r)=>{const l=document.createElement("div");return l.textContent=a,l.onclick=()=>r(),l},n=s?"Open":"Open Folder",o=async()=>{v.style.display="none",await this.openItem(e,s)};if(v.appendChild(i(n,o)),v.appendChild(document.createElement("hr")),v.appendChild(i("Delete",async()=>{v.style.display="none";const a=s?`Are you sure you want to delete "${e}"?`:`Are you sure you want to delete the folder "${e}" and all its contents?`;confirm(a)&&(await this.fs.deleteItem(this.currentPath,e),await this.render())})),v.appendChild(i("Rename",async()=>{v.style.display="none";const a=prompt("Enter new name:",e);a&&a!==e&&(await this.fs.renameItem(this.currentPath,e,a),await this.render())})),s){const a=await this.fs.getFileKind(this.currentPath,e),r=await this.fs.getFileContent(this.currentPath,e);a===y.IMAGE&&v.appendChild(i("Set Wallpaper",()=>{v.style.display="none",D.setWallpaper(r)}))}v.appendChild(i("Properties",()=>{v.style.display="none",this.wm.showPopup(`Name: ${e}
Type: ${s?"File":"Folder"}`)})),Object.assign(v.style,{left:`${t.pageX}px`,top:`${t.pageY}px`,display:"block"})}showBackgroundContextMenu(t){t.preventDefault(),t.stopPropagation(),v.innerHTML=`
      <div id="ctx-new-file">New File</div>
      <div id="ctx-new-folder">New Folder</div>
      <hr>
      <div id="ctx-refresh">Refresh</div>
    `;const e=(s,i)=>{document.getElementById(s).onclick=async()=>{v.style.display="none",await i()}};e("ctx-new-file",async()=>{const s=prompt("Enter file name:","NewFile.txt");s&&(await this.fs.createFile(this.currentPath,s),await this.render())}),e("ctx-new-folder",async()=>{const s=prompt("Enter folder name:","NewFolder");s&&(await this.fs.createFolder(this.currentPath,s),await this.render())}),e("ctx-refresh",async()=>await this.render()),Object.assign(v.style,{left:`${t.pageX}px`,top:`${t.pageY}px`,display:"block"})}}const F=document.getElementById("window-style");let U=F.parentNode;function at(){F.parentNode&&U.removeChild(F)}function rt(){F.parentNode||U.appendChild(F)}class lt{constructor(){this.openWindows=new Map,this.zIndexCounter=1e3,this.gameWindowCount=0}updateTransparency(){this.gameWindowCount>0?at():rt()}createWindow(t,e,s="80vw",i="80vh",n=!1){const o=document.createElement("div");o.className="window",o.id=t,o.dataset.fullscreen="false";const a=s!=null?String(s):"80vw",r=i!=null?String(i):"80vh",l=a.includes("vw")?window.innerWidth*parseFloat(a)/100:parseInt(a),d=r.includes("vh")?window.innerHeight*parseFloat(r)/100:parseInt(r);return Object.assign(o.style,{width:`${l}px`,height:`${d}px`,left:`${(window.innerWidth-l)/2}px`,top:`${(window.innerHeight-d)/2}px`,position:"absolute",zIndex:this.zIndexCounter++}),n&&this.gameWindowCount++,this.updateTransparency(),o}addToTaskbar(t,e,s){if(document.getElementById(`taskbar-${t}`))return;const i=document.createElement("div");if(i.id=`taskbar-${t}`,i.className="taskbar-item",s){const a=document.createElement("img");a.src=s,i.appendChild(a)}const n=document.createElement("span");n.textContent=e,i.appendChild(n),i.onclick=()=>{const a=document.getElementById(t);a&&(a.style.display==="none"?(a.style.display="block",i.classList.add("active")):this.bringToFront(a))},i.oncontextmenu=a=>{a.preventDefault();const r=document.getElementById("taskbar-context-menu");r&&r.remove();const l=document.createElement("div");l.id="taskbar-context-menu",l.className="kde-menu";const d=document.getElementById(t),p=(u,g)=>{const h=document.createElement("div");h.textContent=u,h.className="kde-item",h.onclick=()=>{g(),l.remove()},l.appendChild(h)};p(d.style.display==="none"?"Restore":"Minimize",()=>{d.style.display==="none"?d.style.display="block":this.minimizeWindow(d),this.bringToFront(d)}),p(d.dataset.fullscreen==="true"?"Restore Size":"Maximize",()=>{this.toggleFullscreen(d),this.bringToFront(d)}),p("Bring to Front",()=>this.bringToFront(d)),p("Properties",()=>{const u=this.openWindows.get(t);if(!u)return;const g=document.getElementById(t);if(!g)return;const h=g.dataset,b=g.getBoundingClientRect(),E=[`Window ID: ${t}`,`Title: ${u.title}`,h.appType?`Type: ${h.appType}`:"",h.appId?`App ID: ${h.appId}`:"",h.swf?`SWF Path: ${h.swf}`:"",h.rom?`ROM: ${h.rom}`:"",h.core?`Core: ${h.core}`:"",h.externalUrl?`URL: ${h.externalUrl}`:"",`Width: ${Math.round(b.width)}px`,`Height: ${Math.round(b.height)}px`,`Left: ${Math.round(b.left)}px`,`Top: ${Math.round(b.top)}px`,`Z-Index: ${g.style.zIndex}`,`Fullscreen: ${h.fullscreen==="true"?"Yes":"No"}`].filter(Boolean).map(Z=>`<div style="margin:2px 0;">${Z}</div>`).join(""),C=this.createWindow(`${t}-props`,`Properties: ${u.title}`,"40vw","40vh");C.innerHTML=`
          <div class="window-header">
            <span>Properties: ${u.title}</span>
            ${this.wm.getWindowControls()}
          </div>
          <div class="window-content" style="width:100%; height:100%; overflow:auto; user-select:text;">
            ${E}
          </div>
        `,x.appendChild(C),this.makeDraggable(C),this.makeResizable(C),this.setupWindowControls(C)}),p("Close Window",()=>{this.removeFromTaskbar(t),d&&d.remove()}),document.body.appendChild(l);const f=l.getBoundingClientRect();let w=a.pageX,m=window.innerHeight-a.pageY;w+f.width>window.innerWidth&&(w=window.innerWidth-f.width-10),m+f.height>window.innerHeight&&(m=10),l.style.setProperty("--ctx-left",`${w}px`),l.style.setProperty("--ctx-bottom",`${m}px`),document.addEventListener("click",function u(){l.remove(),document.removeEventListener("click",u)})},document.getElementById("taskbar-windows").appendChild(i),this.openWindows.set(t,{taskbarItem:i,title:e})}registerCloseWindow(t,e){t.addEventListener("click",()=>{const s=document.getElementById(e);if(s)s.remove();else return;this.removeFromTaskbar(e)})}removeFromTaskbar(t){const e=document.getElementById(`taskbar-${t}`);e&&e.remove(),this.openWindows.delete(t)}bringToFront(t){t&&(t.style.zIndex=this.zIndexCounter++)}minimizeWindow(t){t.style.display="none";const e=document.getElementById(`taskbar-${t.id}`);e&&(e.style.background="#1a1a1a")}toggleFullscreen(t){const e=t.dataset.fullscreen==="true",s=t.querySelector(".window-header");if(e)document.fullscreenElement===t&&document.exitFullscreen(),Object.assign(t.style,{width:t.dataset.prevWidth,height:t.dataset.prevHeight,left:t.dataset.prevLeft,top:t.dataset.prevTop}),s&&(s.style.display=""),t.dataset.fullscreen="false";else{Object.assign(t.dataset,{prevWidth:t.style.width,prevHeight:t.style.height,prevLeft:t.style.left,prevTop:t.style.top});const i=()=>{Object.assign(t.style,{width:"100vw",height:"100vh",left:"0",top:"0"}),s&&(s.style.display="none")};t.requestFullscreen?t.requestFullscreen().then(i).catch(i):i(),t.dataset.fullscreen="true";const n=()=>{document.fullscreenElement||(s&&(s.style.display=""),t.dataset.fullscreen="false",document.removeEventListener("fullscreenchange",n))};document.addEventListener("fullscreenchange",n)}}setupWindowControls(t){t.querySelector(".close-btn").onclick=()=>{this.removeFromTaskbar(t.id),t.remove(),t.dataset.isGame==="true"&&(this.gameWindowCount=Math.max(0,this.gameWindowCount-1)),this.updateTransparency()},t.querySelector(".minimize-btn").onclick=()=>this.minimizeWindow(t),t.querySelector(".maximize-btn").onclick=()=>this.toggleFullscreen(t);const e=t.querySelector(".close-btn");e&&this.registerCloseWindow(e),t.addEventListener("mousedown",()=>this.bringToFront(t))}makeDraggable(t){const e=t.querySelector(".window-header");e.onmousedown=s=>{if(s.target.tagName==="BUTTON")return;s.stopPropagation(),this.isDraggingWindow=!0;const i=s.clientX-t.offsetLeft,n=s.clientY-t.offsetTop;document.onmousemove=o=>{t.style.left=`${o.clientX-i}px`,t.style.top=`${o.clientY-n}px`},document.onmouseup=()=>{document.onmousemove=null,this.isDraggingWindow=!1}}}makeResizable(t){const s=i=>{const n=t.getBoundingClientRect();let o="";return i.clientY-n.top<10?o+="n":n.bottom-i.clientY<10&&(o+="s"),i.clientX-n.left<10?o+="w":n.right-i.clientX<10&&(o+="e"),o};t.addEventListener("mousemove",i=>{const n=s(i),o={n:"n-resize",s:"s-resize",w:"w-resize",e:"e-resize",nw:"nw-resize",ne:"ne-resize",sw:"sw-resize",se:"se-resize","":"default"};t.style.cursor=o[n]||"default"}),t.addEventListener("mousedown",i=>{const n=s(i);if(!n)return;i.preventDefault();const o=i.clientX,a=i.clientY,r=t.getBoundingClientRect(),l=r.width,d=r.height,p=r.left,f=r.top,w=u=>{let g=l,h=d,b=p,T=f;n.includes("e")&&(g=l+(u.clientX-o)),n.includes("s")&&(h=d+(u.clientY-a)),n.includes("w")&&(g=l-(u.clientX-o),b=p+(u.clientX-o)),n.includes("n")&&(h=d-(u.clientY-a),T=f+(u.clientY-a));const E=300;g>E&&(t.style.width=`${g}px`,t.style.left=`${b}px`),h>E&&(t.style.height=`${h}px`,t.style.top=`${T}px`)},m=()=>{document.removeEventListener("mousemove",w),document.removeEventListener("mouseup",m)};document.addEventListener("mousemove",w),document.addEventListener("mouseup",m)})}getWindowControls(){return`<div class="window-controls">
              <button class="minimize-btn" title="Minimize">−</button>
              <button class="maximize-btn" title="Maximize">□</button>
              <button class="close-btn" title="Close">X</button>
            </div>
    `}showPopup(t){const e=document.createElement("div");e.innerHTML=`
        <div  style="display:flex; align-items:flex-start;">
            <div style="flex-shrink:0; width:24px; height:24px; margin-right:8px; background:#0078d7; color:#fff; font-weight:bold; font-family:sans-serif; display:flex; justify-content:center; align-items:center; border-radius:50%;">i</div>
            <div style="flex:1;">
                <div style="color:#0078d7; font-weight:bold; font-size:13px; line-height:1.2;">Notification</div>
                <div style="margin-top:2px; font-weight:normal; font-size:12px; color:#000;">${t}</div>
            </div>
            <div style="flex-shrink:0; margin-left:8px; font-weight:bold; cursor:pointer; color:#666;">×</div>
        </div>
        <div style="position:absolute; bottom:-8px; right:16px; width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-top:8px solid #fff;"></div>
    `,e.className="tray-notify",e.querySelector("div:last-child").addEventListener("click",()=>{e.style.bottom="50px",e.style.opacity="0",setTimeout(()=>e.remove(),500)}),e.addEventListener("click",()=>{e.style.bottom="-100px",e.style.opacity="0",setTimeout(()=>e.remove(),500)}),document.body.appendChild(e),setTimeout(()=>{e.style.bottom="50px",e.style.opacity="1"},10),setTimeout(()=>{e.style.bottom="-100px",e.style.opacity="0",setTimeout(()=>e.remove(),500)},5e3)}}class ct{constructor(t){this.wm=t,this.history=[],this.historyIndex=-1,this.currentURL="https://www.google.com/webhp?igu=1"}open(){if(document.getElementById("browser-win")){this.wm.bringToFront(document.getElementById("browser-win"));return}const t=document.createElement("div");t.className="window",t.id="browser-win",t.dataset.fullscreen="false",t.innerHTML=`
      <div class="window-header">
        <span>Browser</span>
        <div class="window-controls">
          <button class="minimize-btn" title="Minimize">−</button>
          <button class="maximize-btn" title="Maximize">□</button>
          <button class="close-btn" title="Close">X</button>
        </div>
      </div>
      <nav class="browser-nav">
        <div>
          <button id="back-btn" disabled aria-label="Click to go back" title="Click to go back">
            ←
          </button>
          <button id="forward-btn" disabled aria-label="Click to go forward" title="Click to go forward">
            →
          </button>
          <button id="reload-btn" aria-label="Reload this page" title="Reload this page">
            ⟳
          </button>
        </div>
        <input id="address-bar" type="url" value="${this.currentURL}" aria-label="Address" enterkeyhint="go">
      </nav>
      <nav class="bookmark-bar">
      <button data-url="https://www.google.com/webhp?igu=1">Google</button>
      <button data-url="https://reeyuki.github.io">Reeyuki Site</button>
      <button data-url="https://liventcord.github.io">LiventCord</button>
      <button data-url="https://www.wikipedia.org">Wikipedia</button>
      <button data-url="https://www.mixconvert.com">Mix Convert</button>
      <button data-url="https://dustinbrett.com/Program%20Files/Browser/dino/index.html">T-Rex Dino</button>
      <button onclick="window.open('https://dn721809.ca.archive.org/0/items/youtube-xvFZjo5PgG0/xvFZjo5PgG0.mp4','_blank')">Click me</button>
      <button data-url="https://bluemaxima.org/flashpoint">Flashpoint Archive</button>
      <button data-url="https://jsfiddle.net">JS Fiddle</button>
      <a href="https://emupedia.net/beta/emuos/">EmuOS</a>
      </nav>
      <iframe id="browser-frame" src="${this.currentURL}" style="width:100%;height:calc(100% - 88px);border:none"></iframe>
    `,x.appendChild(t),this.wm.makeDraggable(t),this.wm.makeResizable(t),this.wm.setupWindowControls(t),this.wm.addToTaskbar(t.id,"Browser","/static/icons/chromium.webp"),this.wm.bringToFront(t),this.wm.registerCloseWindow(t.querySelector(".close-btn"),t.id),this.frame=t.querySelector("#browser-frame"),this.addressInput=t.querySelector("#address-bar"),this.backBtn=t.querySelector("#back-btn"),this.forwardBtn=t.querySelector("#forward-btn"),this.reloadBtn=t.querySelector("#reload-btn"),t.style.width="70vw",t.style.height="70vh",t.style.left="15vw",t.style.top="15vh",this.setupControls(t)}setupControls(t){this.backBtn.onclick=()=>this.goBack(),this.forwardBtn.onclick=()=>this.goForward(),this.reloadBtn.onclick=()=>this.frame.src=this.currentURL,this.addressInput.addEventListener("keydown",e=>{e.key==="Enter"&&this.navigate(this.addressInput.value)}),t.querySelectorAll(".bookmark-bar button").forEach(e=>{e.addEventListener("click",()=>{this.navigate(e.dataset.url)})})}navigate(t){if(!t){console.error("No url found");return}!t.startsWith("http")&&!t.startsWith("chrome")&&(t="https://"+t),this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1)),this.history.push(t),this.historyIndex++,this.updateNavigation()}goBack(){this.historyIndex>0&&(this.historyIndex--,this.updateNavigation())}goForward(){this.historyIndex<this.history.length-1&&(this.historyIndex++,this.updateNavigation())}updateNavigation(){this.currentURL=this.history[this.historyIndex],this.frame.src=this.currentURL,this.addressInput.value=this.currentURL,this.backBtn.disabled=this.historyIndex<=0,this.forwardBtn.disabled=this.historyIndex>=this.history.length-1}}const G="kdeFavorites";function I(){return JSON.parse(localStorage.getItem(G))||[]}function X(c){localStorage.setItem(G,JSON.stringify(c))}function dt(c){let t=I();t.includes(c)||(t.push(c),X(t),B(),_(c,!0))}function pt(c){let t=I();t=t.filter(e=>e!==c),X(t),B(),_(c,!1)}function Y(c){const t=document.createElement("span");return t.textContent="★",t.className="star",t.style.color=I().includes(c)?"gold":"#ccc",t.addEventListener("click",e=>{e.stopPropagation(),I().includes(c)?pt(c):dt(c)}),t.dataset.app=c,t}function _(c,t){document.querySelectorAll(`.kde-item[data-app="${c}"] span`).forEach(s=>{s.textContent==="★"&&(s.style.color=t?"gold":"#ccc")});const e=document.querySelector(`.kde-item[data-app="${c}"]`);e&&(e.style.background=t?"rgba(255, 215, 0, 0.1)":"transparent")}function B(c){if(!c){console.error("No app launcher");return}const t=document.querySelector('.kde-page[data-page="favorites"]');t.innerHTML="";const e=I();if(e.length===0){const s=document.createElement("div");s.textContent="No favorite apps",s.style.padding="10px",s.style.color="#888",t.appendChild(s);return}e.forEach(s=>{const i=document.querySelector(`.kde-item[data-app="${s}"]`);if(!i)return;const n=i.cloneNode(!0);n.style.position="relative",n.style.background="rgba(255, 215, 0, 0.1)",n.onclick=()=>c.launch(s);const o=n.querySelector(".star");o&&o.remove(),n.appendChild(Y(s)),t.appendChild(n)})}function ht(){document.querySelectorAll(".kde-page:not([data-page='favorites']) .kde-item").forEach(c=>{const t=c.dataset.app;c.style.position="relative";const e=Y(t);e.style.opacity="0",e.style.transition="opacity 0.2s",c.appendChild(e),c.addEventListener("mouseenter",()=>e.style.opacity="1"),c.addEventListener("mouseleave",()=>e.style.opacity="0"),I().includes(t)&&(c.style.background="rgba(255, 215, 0, 0.1)")})}function mt(){document.querySelectorAll(".kde-cat").forEach(c=>{c.onclick=()=>{document.querySelectorAll(".kde-cat").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".kde-page").forEach(t=>t.classList.remove("active")),c.classList.add("active"),document.querySelector(`.kde-page[data-page="${c.dataset.cat}"]`).classList.add("active")}}),document.getElementById("kde-search").addEventListener("input",c=>{const t=c.target.value.toLowerCase();document.querySelectorAll(".kde-item").forEach(e=>{e.style.display=e.textContent.toLowerCase().includes(t)?"":"none"})}),ht()}function K(c){if(c=N(c),c==="explorer")return"/static/icons/file.png";if(c==="computer")return"/static/icons/pc.webp";try{return document.querySelector(`#desktop div[data-app="${c}"]`)?.querySelector("img")?.src||null}catch(t){return console.error(t),null}}function ut(c){const t={system:document.querySelector('.kde-page[data-page="system"]'),apps:document.querySelector('.kde-page[data-page="apps"]'),games:document.querySelector('.kde-page[data-page="games"]'),favorites:document.querySelector('.kde-page[data-page="favorites"]')};["system","apps","games"].forEach(e=>{t[e]&&(t[e].innerHTML="")}),Object.entries(c.appMap).forEach(([e,s])=>{const i=document.createElement("div");i.classList.add("kde-item"),i.dataset.app=e;const n=K(e),o=document.createElement("img");o.classList.add("kde-item-icon"),n?(o.src=n,o.alt=""):o.style.display="none";const a=e.charAt(0).toUpperCase()+e.slice(1),r=document.createElement("span");r.textContent=a,i.appendChild(o),i.appendChild(r),i.addEventListener("click",()=>c.launch(e)),s.type==="system"?t.system?.appendChild(i):s.type==="game"||s.type==="swf"?t.games?.appendChild(i):t.apps?.appendChild(i)})}class ft{constructor(t,e,s,i,n,o,a,r){this.wm=t,this.fs=e,this.musicPlayer=s,this.explorerApp=i,this.terminalApp=n,this.notepadApp=o,this.browserApp=a,this.cameraApp=r,this.pageLoadTime=Date.now(),this.TRANSPARENCY_ALLOWED_APP_IDS=new Set(["paint","vscode","liventcord"]);const l=this._getAnalyticsBase("hit-page");this.sendAnalytics({...l,event:"start"}),this.appMap={return:{type:"system",action:()=>window.location.href="/"},explorer:{type:"system",action:()=>this.explorerApp.open()},computer:{type:"system",action:()=>this.explorerApp.open()},terminal:{type:"system",action:()=>this.terminalApp.open()},notepad:{type:"system",action:()=>this.notepadApp.open()},browser:{type:"system",action:()=>this.browserApp.open()},cameraApp:{type:"system",action:()=>this.cameraApp.open()},music:{type:"system",action:()=>this.musicPlayer.open(this.wm)},photopea:{type:"game",url:"https://www.photopea.com"},sonic:{type:"swf",swf:"/static/games/swfGames/sonic.swf"},flight:{type:"swf",swf:"/static/games/swfGames/flight.swf"},swarmQueen:{type:"swf",swf:"/static/games/swfGames/swarmQueen.swf"},paint:{type:"game",url:"https://paint.js.org/"},pacman:{type:"game",url:"https://pacman-e281c.firebaseapp.com"},pvz:{type:"game",url:"https://emupedia.net/emupedia-game-pvz"},pvz2:{type:"remote",url:"https://play.pvzge.com"},pvzHybrid:{type:"remote",url:"https://www.miniplay.com/embed/plants-vs-zombies-hybrid-story"},tetris:{type:"game",url:"https://turbowarp.org/embed.html?autoplay#31651654"},roads:{type:"game",url:"https://slowroads.io"},vscode:{type:"game",url:"https://emupedia.net/emupedia-app-vscode"},isaac:{type:"game",url:"https://emupedia.net/emupedia-game-binding-of-isaac"},mario:{type:"game",url:"https://emupedia.net/emupedia-game-mario"},papaGames:{type:"game",url:"https://papasgamesfree.io"},zombieTd:{type:"swf",swf:"/static/games/swfGames/zombietd.swf"},zombotron:{type:"swf",swf:"/static/games/zombotron/zombotron.swf"},zombotron2:{type:"swf",swf:"/static/games/zombotron/zombotron2.swf"},zombotron2Time:{type:"game",url:"/static/rfiv.html?game=zombotron"},breach:{type:"swf",swf:"/static/games/swfGames/breach.swf"},fancyPants:{type:"swf",swf:"/static/games/swfGames/fancypantsadventure.swf"},fancyPants2:{type:"swf",swf:"/static/games/swfGames/fancypantsadventure2.swf"},fancyPants3:{type:"swf",swf:"/static/games/swfGames/fancypantsadventure3.swf"},strikeForce:{type:"swf",swf:"https://cache.armorgames.com/files/games/strikeforce-kitty-16008.swf?v=1404201513"},strikeForce2:{type:"swf",swf:"https://cache.armorgames.com/files/games/strikeforce-kitty-2-17643.swf?v=1423725280"},baloonsTd5:{type:"swf",swf:"/static/games/swfGames/baloonstd5.swf"},baloonsTd6:{type:"swf",swf:"https://truffled.lol/iframe.html?url=%2Fgames%2Fbtd6%2Findex.html"},trinitas:{type:"game",url:"/static/games/trinitas"},jojo:{type:"game",url:"https://www.retrogames.cc/embed/8843-jojos-bizarre-adventure%3A-heritage-for-the-future-jojo-no-kimyou-na-bouken%3A-mirai-e-no-isan-japan-990927-no-cd.html"},gtaVc:{type:"game",url:"/static/vciframe.html"},subwaySurfers:{type:"game",url:"https://5dd312fa-015f-11ea-ad56-9cb6d0d995f7.gdn.poki.com/680bfc01-4c2f-477d-9a5c-ab04a8349fc6/index.html"},mutantFighting:{type:"swf",swf:"https://cache.armorgames.com/files/games/mutant-fighting-cup-14425.swf?v=1373587528"},mutantFighting2:{type:"swf",swf:"/static/games/swfGames/mutantfightingcup2.swf"},finnAndBones:{type:"game",url:"/static/flashpointarchive.html?fpGameName=finnAndBones"},obama:{type:"game",url:"/static/flashpointarchive.html?fpGameName=obama-alien-defense"},intrusion2:{type:"swf",swf:"/static/games/swfGames/intrusion2.swf"},dan:{type:"game",url:"https://www.silvergames.com/en/dan-the-man/gameframe"},infectonator:{type:"swf",swf:"https://cache.armorgames.com/files/games/infectonator-5020.swf?v=1373587522"},infectonator2:{type:"swf",swf:"https://cache.armorgames.com/files/games/infectonator-2-13150.swf?v=1373587527"},newyorkShark:{type:"swf",swf:"https://cache.armorgames.com/files/games/new-york-shark-12969.swf?v=1373587527"},swordsSouls:{type:"swf",swf:"https://cache.armorgames.com/files/games/swordssouls-17817.swf?v=1464609285"},corporationInc:{type:"swf",swf:"https://cache.armorgames.com/files/games/corporation-inc-7348.swf?v=1373587524"},aground:{type:"game",url:"https://cache.armorgames.com/files/games/aground-18245/index.html?v=1591832301"},mobyDick:{type:"swf",swf:"https://cache.armorgames.com/files/games/moby-dick-the-video--7199.swf?v=1373587524"},mobyDick2:{type:"swf",swf:"https://cache.armorgames.com/files/games/moby-dick-2-12662.swf?v=1373587526"},elfStory:{type:"swf",swf:"https://cache.armorgames.com/files/games/elf-story-14680.swf?v=1373587528"},frogDares:{type:"swf",swf:"https://cache.armorgames.com/files/games/frog-dares-12672.swf?v=1373587526"},kamikazePigs:{type:"swf",swf:"https://cache.armorgames.com/files/games/kamikaze-pigs-13545.swf?v=1373587527"},icyFishes:{type:"swf",swf:"https://cache.armorgames.com/files/games/icy-fishes-12977.swf?v=1373587527"},feedUs6:{type:"swf",swf:"/static/games/swfGames/feeduslostisland.swf"},superrobotwar:{type:"game",url:"/static/flashpointarchive.html?fpGameName=super-robot-war"},feedUsPirates:{type:"swf",swf:"/static/games/swfGames/feeduspirates.swf"},epicbossfighter2:{type:"swf",swf:"/static/games/swfGames/EpicBossFighter2.swf"},avatarFortressFight2:{type:"swf",swf:"/static/games/swfGames/avatarFortressFight2.swf"},incredibles:{type:"swf",swf:"/static/games/swfGames/incredibles.swf"},savagePursuit:{type:"swf",swf:"/static/games/swfGames/savagepursuit.swf"},theVisitor:{tyoe:"swf",swf:"/static/games/swfGames/theVisitor.swf"},cactusMcCoy:{type:"game",url:"https://papasgamesfree.io/cactus-mccoy-1"},jackSmith:{type:"game",url:"https://papasgamesfree.io/jacksmith"},pokemonRed:{type:"gba",url:"pokemon-red.gba"},pokemonEmerald:{type:"gba",url:"pokemon-emerald.gba"},pokemonPlatinum:{type:"nds",url:"pokemon-platinum.nds"},pokemonHeartgold:{type:"nds",url:"pokemon-heartgold.nds"},pokemonWhite:{type:"nds",url:"pokemon-white.nds"},pokemonWhite2:{type:"nds",url:"pokemon-white-2.zip"},minecraft:{type:"remote",url:"https://eaglercraft.com/play"},liventcord:{type:"game",url:"https://liventcord.github.io"},fnaf:{type:"game",url:"/static/games/fnaf"},geometryDash:{type:"game",url:"https://emupedia.net/emupedia-game-geometry-dash"},cutTheRope:{type:"game",url:"https://emupedia.net/emupedia-game-cut-the-rope2"},game2048:{type:"game",url:"https://emupedia.net/emupedia-game-2048"},pinball:{type:"game",url:"https://emupedia.net/emupedia-game-space-cadet-pinball"},flappyBird:{type:"game",url:"https://emupedia.net/emupedia-game-flappy-bird"},jetpack:{type:"game",url:"https://emupedia.net/emupedia-game-jetpack-joyride"},happyWheels:{type:"game",url:"https://emupedia.net/emupedia-game-happy-wheels/flash"},fistPunch:{type:"game",url:"/static/flashpointarchive.html?fpGameName=fistPunch"},hollowKnight:{type:"game",url:"/static/hollowknight.html"},slimeRancher:{type:"game",url:"https://dev.snubby.top"},kindergarten:{type:"game",url:"/static/games/gnmath/kindergarten"},kindergarten2:{type:"game",url:"/static/games/gnmath/kindergarten2"},cuphead:{type:"game",url:"https://truffled.lol/games/Cuphead/index.html"},raft:{type:"game",url:"https://truffled.lol/games/raft/index.html"},celeste:{type:"game",url:"https://truffled.lol/games/celeste/index.html"},terraria:{type:"game",url:"https://truffled.lol/games/terraria/terraria-wrapper.html"},yandereSim:{type:"game",url:"/static/games/gnmath/yandere.html"},undertale:{type:"game",url:"https://truffled.lol/games/bts"},balatro:{type:"game",url:"https://truffled.lol/games/balatro/index.html"},granny:{type:"game",url:"/static/games/gnmath/granny.html"},bendy:{type:"game",url:"/static/games/gnmath/bendy.html"},tattletail:{type:"game",url:"https://truffled.lol/games/tattletail/index.html"},repo:{type:"game",url:"/static/games/gnmath/repo.html"},omori:{type:"game",url:"/static/games/gnmath/omori.html"},ultrakill:{type:"game",url:"/static/games/gnmath/ultrakill.html"}},ut(this)}launch(t){const e=this.appMap[t];if(!e){console.error(`App ${t} not found.`);return}console.log("Starting app : ",t);const s=this._getAnalyticsBase(t);this.sendAnalytics({...s,event:"launch"}),{system:()=>e.action(),swf:()=>this.openRuffleApp(t,e.swf,s),gba:()=>this.openEmulatorApp(t,e.url,"gba",s),nds:()=>this.openEmulatorApp(t,e.url,"nds",s),game:()=>this.openGameApp(t,e.url,s),html:()=>this.openHtmlApp(t,e.html,s,e),remote:()=>this.openRemoteApp(e.url)}[e.type]?.()}_getAnalyticsBase(t){const e=Date.now(),s=e-this.pageLoadTime;return{app:t,timestamp:e,sessionAgeMs:s}}sendAnalytics(t){window.location.hostname!=="localhost"&&fetch("https://analytics.liventcord-a60.workers.dev/analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}recordUsage(t,e){const s=Date.now(),i=document.getElementById(t),n=()=>{const o=Date.now()-s;this.sendAnalytics({...e,event:"usage",durationMs:o})};i.querySelector(".close-btn").addEventListener("click",n),i.addEventListener("blur",n)}openRemoteApp(t){const e=this._getAnalyticsBase(t);this.sendAnalytics({...e,event:"launch"}),window.open(t,"_blank","noopener,noreferrer")}openHtmlApp(t,e,s){if(document.getElementById(`${t}-win`)){this.wm.bringToFront(document.getElementById(`${t}-win`));return}this.createWindow(t,t.replace(/([A-Z])/g," $1").replace(/^./,i=>i.toUpperCase()),e,null,t,s)}openRuffleApp(t,e){if(!e)return;const s=document.querySelector(`[data-app="${t}"] div`);s&&(t=s.textContent);const i=e.replace(/[^a-zA-Z0-9]/g,"");if(document.getElementById(`${i}-win`)){this.wm.bringToFront(document.getElementById(`${i}-win`));return}const n=`<embed src="${e}" width="100%" height="100%">`;this.createWindow(i,t.toUpperCase(),n,null,t,{type:"swf",swf:e})}openEmulatorApp(t,e,s){const i=document.querySelector(`[data-app="${t}"] div`);i&&(t=i.textContent);const n=`${s}-${e.replace(/\W/g,"")}-${Date.now()}`;if(document.getElementById(n)){this.wm.bringToFront(document.getElementById(n));return}const o=`/static/emulatorjs.html?rom=${encodeURIComponent(e)}&core=${encodeURIComponent(s)}&color=%230064ff`,a=`<iframe src="${o}" style="width:100%; height:100%; border:none;" allow="autoplay; fullscreen; clipboard-write; encrypted-media; picture-in-picture" sandbox="allow-forms allow-downloads allow-modals allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation"></iframe>`;this.createWindow(n,t,a,o,t,{type:s,rom:e,core:s})}openGameApp(t,e){let s;const i=document.querySelector(`[data-app="${t}"] div`);if(i&&(s=i.textContent),document.getElementById(`${t}-win`)){this.wm.bringToFront(document.getElementById(`${t}-win`));return}const n=`<iframe src="${e}" style="width:100%; height:100%; border:none;" allow="autoplay; fullscreen; clipboard-write; encrypted-media; picture-in-picture" sandbox="allow-forms allow-downloads allow-modals allow-pointer-lock allow-popups allow-same-origin allow-scripts allow-top-navigation-by-user-activation"></iframe>`;this.createWindow(t,s,n,e,t,{type:"game"})}isTransparencyBlocked(t,e){return!(e.type==="system"||this.TRANSPARENCY_ALLOWED_APP_IDS.has(t))}createWindow(t,e,s,i=null,n=null,o={}){const a=this.isTransparencyBlocked(n,o),r=this.wm.createWindow(`${t}-win`,e,"80vw","80vh",a);r.dataset.appType=o.type||"",r.dataset.externalUrl=i||"",r.dataset.appId=n||"",r.dataset.swf=o.swf||"",r.dataset.isGame=a,r.dataset.rom=o.rom||"",r.dataset.core=o.core||"",console.log(`Id: ${t}, ${n}, appMeta ${o.toString()}, title: ${e}`),r.innerHTML=`
      <div class="window-header">
        <span>${e}</span>
        <div class="window-controls">
          <button class="minimize-btn" title="Minimize">−</button>
          ${i?'<button class="external-btn" title="Open in External">↗</button>':""}
          <button class="maximize-btn" title="Maximize">□</button>
          <button class="close-btn" title="Close">X</button>
        </div>
      </div>
      <div class="window-content" style="width:100%; height:100%;">
        ${s}
      </div>
    `,x.appendChild(r),this.wm.makeDraggable(r),this.wm.makeResizable(r),this.wm.setupWindowControls(r),this.wm.bringToFront(r),i&&r.querySelector(".external-btn").addEventListener("click",()=>this.openRemoteApp(i));const l=K(n||t);this.wm.addToTaskbar(r.id,e,l),this.recordUsage(`${t}-win`)}}class gt{constructor(t,e){this.fs=t,this.wm=e}setExplorer(t){this.explorerApp=t}open(t="Untitled",e="",s=null){const i=`notepad-${t.replace(/\s/g,"")}`;if(document.getElementById(i)){this.wm.bringToFront(document.getElementById(i));return}const n=this.wm.createWindow(i,`${t} - Notepad`,"600px","400px");Object.assign(n.style,{left:"250px",top:"150px"}),n.innerHTML=`
      <div class="window-header">
        <span>${t} - Notepad</span>
        <div class="window-controls">
          <button class="minimize-btn" title="Minimize">−</button>
          <button class="maximize-btn" title="Maximize">□</button>
          <button class="close-btn" title="Close">X</button>
        </div>
      </div>
      <div class="notepad-menu">
        <button class="notepad-btn" data-action="save">Save</button>
        <button class="notepad-btn" data-action="saveAs">Save As</button>
        <button class="notepad-btn" data-action="open">Open</button>
      </div>
      <div class="window-content">
        <textarea class="notepad-textarea" style="width:100%; height:calc(100% - 40px); border:none; padding:10px; font-family:monospace;">${e}</textarea>
      </div>
    `,x.appendChild(n),this.wm.makeDraggable(n),this.wm.makeResizable(n),this.wm.setupWindowControls(n),this.wm.addToTaskbar(n.id,`${t} - Notepad`,"/static/icons/music.png"),this.setupNotepadControls(n,t,s)}setupNotepadControls(t,e,s){const i=t.querySelector(".notepad-textarea");t.querySelectorAll(".notepad-btn").forEach(o=>{o.onclick=()=>{const a=o.dataset.action;a==="save"?this.saveFile(t,i,e,s):a==="saveAs"?this.saveAsFile(i):a==="open"&&this.openFileDialog()}})}saveFile(t,e,s,i){if(!i){this.saveAsFile(e);return}const n=e.value;this.fs.updateFile(i,s,n),this.wm.showPopup(`File saved: ${s}`)}saveAsFile(t){const e=prompt("Enter file name:","NewFile.txt");if(!e)return;const s=prompt("Enter path (e.g., home/reeyuki/Documents):","home/reeyuki/Documents");if(!s)return;const i=s.split("/").filter(o=>o),n=t.value;try{this.fs.createFile(i,e,n),this.wm.showPopup(`File saved: ${e} at /${s}`)}catch(o){console.error(o),this.wm.showPopup("Error saving file. Please check the path.")}}openFileDialog(){this.explorerApp.open(async(t,e)=>{const s=await this.fs.getFileContent(t,e);this.open(e,s,t)})}}class wt{constructor(t){this.wm=t,this.stream=null,this.mediaRecorder=null,this.recordedChunks=[],this.recordings=[],this.recordingInterval=null,this.historyWin=null}open(){if(document.getElementById("camera-win")){this.wm.bringToFront(document.getElementById("camera-win"));return}const t=document.createElement("div");t.className="window",t.id="camera-win",t.dataset.fullscreen="false",t.innerHTML=`
      <div class="window-header">
        <span>Camera</span>
        ${this.wm.getWindowControls()}
      </div>
      <div style="padding:10px; display:flex; flex-direction:column; align-items:center; position:relative;">
      <div class="video-shell">
        <video id="camera-video" autoplay playsinline></video>
        <span id="recording-icon"></span>
        <span id="recording-timer"></span>
      </div>

        <div style="margin-top:10px; display:flex; gap:10px;">
          <button id="take-photo-btn" style="padding:5px 15px;">Take Photo</button>
          <button id="start-record-btn" style="padding:5px 15px;">Start Recording</button>
          <button id="stop-record-btn" style="padding:5px 15px;" disabled>Stop Recording</button>
          <button id="start-screen-btn" style="padding:5px 15px;">Record Screen</button>
          <button id="open-history-btn" style="padding:5px 15px;">History</button>
        </div>
        <a id="download-link" style="display:none; margin-top:10px;"></a>
      </div>
    `,x.appendChild(t),this.wm.makeDraggable(t),this.wm.makeResizable(t),this.wm.setupWindowControls(t),this.wm.addToTaskbar(t.id,"Camera","/static/icons/camera.svg"),this.wm.bringToFront(t);const e=t.querySelector(".close-btn");e.addEventListener("click"),this.wm.registerCloseWindow(e,t.id),this.video=t.querySelector("#camera-video"),this.takePhotoBtn=t.querySelector("#take-photo-btn"),this.startRecordBtn=t.querySelector("#start-record-btn"),this.stopRecordBtn=t.querySelector("#stop-record-btn"),this.downloadLink=t.querySelector("#download-link"),this.recordingIcon=t.querySelector("#recording-icon"),this.recordingTimer=t.querySelector("#recording-timer"),this.historyBtn=t.querySelector("#open-history-btn"),this.startScreenBtn=t.querySelector("#start-screen-btn"),t.style.width="50vw",t.style.height="70vh",t.style.left="25vw",t.style.top="15vh",this.startCamera(),this.takePhotoBtn.onclick=()=>this.takePhoto(),this.startRecordBtn.onclick=()=>this.startRecording(),this.stopRecordBtn.onclick=()=>this.stopRecording(),this.historyBtn.onclick=()=>this.openHistoryWindow(),this.startScreenBtn.onclick=()=>this.startScreenRecording(),this.db=this.initDB(),this.restoreHistory()}async startCamera(){try{this.stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),this.video.srcObject=this.stream}catch(t){this.wm.showPopup("Camera access denied or not available."),console.error(t)}}takePhoto(){const t=document.createElement("canvas");t.width=this.video.videoWidth,t.height=this.video.videoHeight,t.getContext("2d").drawImage(this.video,0,0);const e=t.toDataURL("image/png");this.downloadLink.href=e,this.downloadLink.download="photo.png",this.downloadLink.textContent="Download Photo",this.downloadLink.style.display="block"}startRecording(){this.stream&&(this.recordedChunks=[],this.mediaRecorder=new MediaRecorder(this.stream),this.mediaRecorder.ondataavailable=t=>{t.data.size>0&&this.recordedChunks.push(t.data)},this.mediaRecorder.onstop=()=>{const t=new Blob(this.recordedChunks,{type:"video/webm"}),e=URL.createObjectURL(t);this.addRecording(e,t),this.stopTimer(),this.downloadLink.href=e,this.downloadLink.download=`video-${Date.now()}.webm`,this.downloadLink.textContent="Download Video",this.downloadLink.style.display="block",this.historyWin&&this.renderHistory()},this.mediaRecorder.start(),this.startRecordBtn.disabled=!0,this.stopRecordBtn.disabled=!1,this.recordingIcon.style.display="block",this.startTimer())}stopRecording(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&(this.mediaRecorder.stop(),this.stopTimer(),this.recordingIcon.style.display="none",this.startRecordBtn.disabled=!1,this.stopRecordBtn.disabled=!0)}async startScreenRecording(){try{const t=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0});this.activeStream=t,this.video.srcObject=t,this.recordedChunks=[],this.mediaRecorder=new MediaRecorder(t),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.recordedChunks.push(e.data)},this.mediaRecorder.onstop=()=>{const e=new Blob(this.recordedChunks,{type:"video/webm"}),s=URL.createObjectURL(e);this.addRecording(s,e),this.downloadLink.href=s,this.downloadLink.download=`screen-${Date.now()}.webm`,this.downloadLink.textContent="Download Screen Recording",this.downloadLink.style.display="block",this.stopTimer(),this.recordingIcon.style.display="none",this.startRecordBtn.disabled=!1,this.stopRecordBtn.disabled=!0,this.activeStream.getTracks().forEach(i=>i.stop()),this.activeStream=null,this.video.srcObject=this.stream,this.historyWin&&this.renderHistory()},t.getVideoTracks()[0].onended=()=>{this.mediaRecorder.state!=="inactive"&&this.mediaRecorder.stop()},this.mediaRecorder.start(),this.startRecordBtn.disabled=!0,this.stopRecordBtn.disabled=!1,this.recordingIcon.style.display="block",this.startTimer()}catch(t){console.error(t),this.wm.showPopup("Screen capture cancelled or not allowed")}}startTimer(){let t=0;this.recordingTimer.textContent="00:00",this.recordingInterval=setInterval(()=>{t++;const e=String(Math.floor(t/60)).padStart(2,"0"),s=String(t%60).padStart(2,"0");this.recordingTimer.textContent=`${e}:${s}`},1e3)}stopTimer(){clearInterval(this.recordingInterval),this.recordingTimer.textContent=""}async addRecording(t,e){const s={id:crypto.randomUUID(),name:`Recording ${new Date().toLocaleTimeString()}`,blob:e};if(this.recordings.unshift({...s,url:URL.createObjectURL(e)}),await this.saveRecordingToDB(s),this.recordings.length>5){const i=this.recordings.pop();URL.revokeObjectURL(i.url),await this.deleteRecordingFromDB(i.id)}}openHistoryWindow(){if(this.historyWin){this.wm.bringToFront(this.historyWin);return}this.historyWin=document.createElement("div"),this.historyWin.className="window",this.historyWin.id="history-win",this.historyWin.innerHTML=`
      <div class="window-header">
        <span>Recordings History</span>
        ${this.wm.getWindowControls()}
      </div>
      <div id="history-list" style="padding:10px; display:flex; flex-direction:column; gap:5px; overflow-y:auto; height:calc(100% - 30px);"></div>
    `,x.appendChild(this.historyWin),this.wm.makeDraggable(this.historyWin),this.wm.makeResizable(this.historyWin),this.wm.setupWindowControls(this.historyWin),this.wm.bringToFront(this.historyWin),this.historyWin.querySelector(".close-btn").onclick=()=>{this.historyWin.remove(),this.historyWin=null},this.historyWin.style.width="30vw",this.historyWin.style.height="50vh",this.historyWin.style.left="60vw",this.historyWin.style.top="20vh",this.renderHistory()}renderHistory(){if(!this.historyWin)return;const t=this.historyWin.querySelector("#history-list");t.innerHTML="",this.recordings.forEach(e=>{const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="space-between",s.style.gap="6px",s.style.borderBottom="1px solid #ccc",s.style.padding="6px";const i=document.createElement("span");i.textContent=e.name,i.style.cursor="pointer",i.onclick=()=>this.playRecording(e.url);const n=document.createElement("div");n.style.display="flex",n.style.gap="4px";const o=document.createElement("button");o.textContent="Rename",o.onclick=()=>this.renameRecording(e.id);const a=document.createElement("button");a.textContent="Delete",a.onclick=()=>this.deleteRecording(e.id),n.appendChild(o),n.appendChild(a),s.appendChild(i),s.appendChild(n),t.appendChild(s)})}async renameRecording(t){const e=this.recordings.find(n=>n.id===t);if(!e)return;const s=prompt("Rename recording:",e.name);if(!s)return;e.name=s;const i={id:t,name:s,blob:e.blob};await this.saveRecordingToDB(i),this.renderHistory()}async deleteRecording(t){const e=this.recordings.findIndex(s=>s.id===t);e!==-1&&(URL.revokeObjectURL(this.recordings[e].url),this.recordings.splice(e,1),await this.deleteRecordingFromDB(t),this.renderHistory())}playRecording(t){const e=document.createElement("div");e.className="window",e.innerHTML=`
      <div class="window-header">
        <span>Playback</span>
        <div class="window-controls">
          <button class="close-btn">X</button>
        </div>
      </div>
      <video controls autoplay style="width:100%; height:90%;"></video>
    `,x.appendChild(e),this.wm.makeDraggable(e),this.wm.makeResizable(e),this.wm.bringToFront(e),e.querySelector(".close-btn").onclick=()=>e.remove();const s=e.querySelector("video");s.src=t,e.style.width="50vw",e.style.height="50vh",e.style.left="30vw",e.style.top="25vh"}stopCamera(){this.stream&&this.stream.getTracks().forEach(t=>t.stop())}async initDB(){return new Promise((t,e)=>{const s=indexedDB.open("camera-recordings-db",1);s.onupgradeneeded=i=>{i.target.result.createObjectStore("recordings",{keyPath:"id"})},s.onsuccess=i=>t(i.target.result),s.onerror=i=>e(i)})}async saveRecordingToDB(t){const e=await this.db;return new Promise(s=>{const i=e.transaction("recordings","readwrite");i.objectStore("recordings").put(t),i.oncomplete=s})}async deleteRecordingFromDB(t){const e=await this.db;return new Promise(s=>{const i=e.transaction("recordings","readwrite");i.objectStore("recordings").delete(t),i.oncomplete=s})}async loadRecordingsFromDB(){const t=await this.db;return new Promise(e=>{const i=t.transaction("recordings","readonly").objectStore("recordings").getAll();i.onsuccess=()=>e(i.result)})}async restoreHistory(){const t=await this.loadRecordingsFromDB();this.recordings=t.map(e=>({...e,url:URL.createObjectURL(e.blob)}))}}class yt{constructor(t,e,s,i){this.appLauncher=t,this.notepadApp=e,this.explorerApp=s,this.fs=i,this.desktop=document.getElementById("desktop"),this.startButton=document.getElementById("start-button"),this.startMenu=document.getElementById("start-menu"),this.contextMenu=document.getElementById("context-menu"),this.selectionBox=document.getElementById("selection-box"),this.state={clipboard:null,selectedIcons:new Set,gridSize:{width:80,height:100,gap:5},isSelecting:!1,dragTarget:null,isUserDragging:!1},this.templates={iconContextMenu:[{id:"ctx-open",label:"Open",action:"open"},{id:"ctx-cut",label:"Cut",action:"cut"},{id:"ctx-copy",label:"Copy",action:"copy"},{id:"ctx-delete",label:"Delete",action:"delete"},{id:"ctx-properties",label:"Properties",action:"properties"}],folderContextMenu:[{id:"ctx-open-folder",label:"Open",action:"openFolder"},{id:"ctx-delete-folder",label:"Delete",action:"deleteFolder"},{id:"ctx-rename-folder",label:"Rename",action:"renameFolder"}],desktopContextMenu:[{id:"ctx-new-notepad",label:"New Notepad",action:"newNotepad"},{id:"ctx-new-folder",label:"New Folder",action:"newFolder"},{id:"ctx-open-explorer",label:"Open File Explorer",action:"openExplorer"},{id:"ctx-paste",label:"Paste",action:"paste",condition:()=>this.state.clipboard},"hr",{id:"ctx-refresh",label:"Refresh",action:"refresh"}]},this.setupEventListeners(),this.initializeDesktopFiles()}pxToPercent(t,e){const s=e==="x"?this.desktop.clientWidth:this.desktop.clientHeight;return t/s*100}percentToPx(t,e){const s=e==="x"?this.desktop.clientWidth:this.desktop.clientHeight;return t/100*s}setupEventListeners(){this.startButton.addEventListener("click",t=>{t.stopPropagation(),this.toggleStartMenu()}),this.startMenu.addEventListener("click",t=>t.stopPropagation()),document.addEventListener("click",()=>{this.closeAllMenus()}),this.desktop.addEventListener("contextmenu",t=>{this.handleContextMenu(t)}),this.setupIconHandlers(),this.setupInteractableSelection(),this.setupStartMenu(),this.setupKeyboardShortcuts(),this.setupResizeHandler()}setupResizeHandler(){let t;window.addEventListener("resize",()=>{clearTimeout(t),t=setTimeout(()=>{this.repositionAllIcons()},100)})}repositionAllIcons(){document.querySelectorAll(".icon.selectable").forEach(e=>{const s=parseFloat(e.dataset.leftPercent),i=parseFloat(e.dataset.topPercent);if(!isNaN(s)&&!isNaN(i)){const n=this.percentToPx(s,"x"),o=this.percentToPx(i,"y");Object.assign(e.style,{left:`${n}px`,top:`${o}px`})}})}setupKeyboardShortcuts(){let t={x:50,y:50};document.addEventListener("mousemove",e=>{t={x:e.pageX,y:e.pageY}}),document.addEventListener("keydown",e=>{if(e.ctrlKey&&e.code==="KeyC"){e.preventDefault();const s=Array.from(this.state.selectedIcons);s.length&&this.copySelectedIcons(s)}if(e.ctrlKey&&e.code==="KeyX"){e.preventDefault();const s=Array.from(this.state.selectedIcons);s.length&&this.cutSelectedIcons(s)}if(e.ctrlKey&&e.code==="KeyV"){if(e.preventDefault(),!this.state.clipboard)return;this.pasteIcons(t.x,t.y)}})}toggleStartMenu(){this.startMenu.style.display=this.startMenu.style.display==="flex"?"none":"flex",B(this.appLauncher)}closeAllMenus(){this.startMenu.style.display="none",this.contextMenu.style.display="none"}handleContextMenu(t){t.target.classList.contains("folder-icon")?(t.preventDefault(),this.showFolderContextMenu(t,t.target)):t.target.classList.contains("selectable")?(t.preventDefault(),this.showIconContextMenu(t,t.target)):t.target===this.desktop&&(t.preventDefault(),this.showDesktopContextMenu(t))}setupIconHandlers(){document.querySelectorAll(".icon.selectable").forEach(t=>{this.makeIconInteractable(t)})}makeIconInteractable(t){this.setIconNonDraggable(t),this.attachIconEvents(t),this.setupInteractDrag(t)}setIconNonDraggable(t){t.draggable=!1,Object.assign(t.style,{userSelect:"none",webkitUserDrag:"none",cursor:"default"})}attachIconEvents(t){t.addEventListener("dblclick",e=>{e.stopPropagation(),t.classList.contains("folder-icon")?this.openFolder(t.dataset.folderName):this.appLauncher.launch(t.dataset.app,t)}),t.addEventListener("mousedown",e=>{this.handleIconSelection(t,e.ctrlKey)})}async openFolder(t){this.explorerApp.open(),await this.explorerApp.navigate(["Desktop",t])}handleIconSelection(t,e){e?this.toggleSelection(t):this.state.selectedIcons.has(t)||(this.clearSelection(),this.addToSelection(t))}setupInteractDrag(t){const e=A(t);e.resizable(!1),e.draggable({inertia:!1,modifiers:[A.modifiers.restrict({restriction:this.desktop,elementRect:{top:0,left:0,bottom:1,right:1}})],autoScroll:!1,cursorChecker:()=>null,listeners:{start:s=>this.onDragStart(s),move:s=>this.onDragMove(s),end:s=>this.onDragEnd(s)}})}onDragStart(){this.state.isUserDragging=!0,this.state.selectedIcons.forEach(t=>{Object.assign(t.style,{opacity:"0.7",zIndex:"1000",cursor:"move"})})}onDragMove(t){const{dx:e,dy:s}=t;this.state.selectedIcons.forEach(i=>{const n=parseFloat(i.style.left)||0,o=parseFloat(i.style.top)||0,a=Math.max(0,n+e),r=Math.max(0,o+s);Object.assign(i.style,{left:`${a}px`,top:`${r}px`}),i.dataset.leftPercent=this.pxToPercent(a,"x"),i.dataset.topPercent=this.pxToPercent(r,"y")}),this.updateDragTarget(t)}updateDragTarget(t){const e=document.querySelectorAll(".folder-icon");let s=null;e.forEach(i=>{const n=i.getBoundingClientRect();t.clientX>=n.left&&t.clientX<=n.right&&t.clientY>=n.top&&t.clientY<=n.bottom&&(s=i)}),this.state.dragTarget&&(this.state.dragTarget.style.outline=""),s&&!this.state.selectedIcons.has(s)?(s.style.outline="2px solid #0078d7",this.state.dragTarget=s):this.state.dragTarget=null}async moveIconsToFolder(t,e){for(const s of t){if(s.classList.contains("folder-icon"))continue;const i=s.querySelector("div"),o=`${i?i.textContent.trim():"Unknown"}.desktop`,a=await this.fs.getFileContent(["Desktop"],o);await this.fs.createFile(["Desktop",e],o,a,"text"),await this.fs.deleteItem(["Desktop"],o),s.remove(),this.state.selectedIcons.delete(s)}this.clearSelection()}async updateDesktopFilePositions(){for(const t of this.state.selectedIcons){if(t.classList.contains("folder-icon"))continue;const e=t.querySelector("div"),s=e?e.textContent.trim():"Unknown",i=`${s}.desktop`,n=t.dataset.app,o={explorer:"/static/icons/pc.webp",notepad:"/static/icons/notepad.webp",flash:"/static/icons/flash.png"},a=parseFloat(t.dataset.leftPercent)||this.pxToPercent(parseFloat(t.style.left)||0,"x"),r=parseFloat(t.dataset.topPercent)||this.pxToPercent(parseFloat(t.style.top)||0,"y"),l=JSON.stringify({app:n,name:s,path:o[n]||"/static/icons/file.png",position:{leftPercent:a,topPercent:r}});await this.fs.createFile(["Desktop"],i,l,"text")}}snapIconToGrid(t){const{width:e,height:s,gap:i}=this.state.gridSize,n=e+i,o=s+i;let a=parseFloat(t.style.left)||0,r=parseFloat(t.style.top)||0,l=Math.round(a/n)*n+i,d=Math.round(r/o)*o+i;for(;this.isPositionOccupied(l,d,t);){const p=this.desktop.clientHeight;d+=o,d+s>p&&(d=i,l+=n)}Object.assign(t.style,{left:`${l}px`,top:`${d}px`}),t.dataset.leftPercent=this.pxToPercent(l,"x"),t.dataset.topPercent=this.pxToPercent(d,"y")}isPositionOccupied(t,e,s){const i=Array.from(document.querySelectorAll(".icon.selectable")),n=10;return i.some(o=>{if(o===s)return!1;const a=parseFloat(o.style.left)||0,r=parseFloat(o.style.top)||0;return Math.abs(a-t)<n&&Math.abs(r-e)<n})}addToSelection(t){this.state.selectedIcons.add(t),t.classList.add("selected")}removeFromSelection(t){this.state.selectedIcons.delete(t),t.classList.remove("selected")}toggleSelection(t){this.state.selectedIcons.has(t)?this.removeFromSelection(t):this.addToSelection(t)}clearSelection(){this.state.selectedIcons.forEach(t=>{t.classList.remove("selected")}),this.state.selectedIcons.clear()}createContextMenuHTML(t){return t.filter(e=>typeof e=="string"?!0:!e.condition||e.condition()).map(e=>e==="hr"?"<hr>":`<div id="${e.id}">${e.label}</div>`).join("")}attachContextMenuHandlers(t,e){t.forEach(s=>{if(typeof s=="string"||s.condition&&!s.condition())return;const i=document.getElementById(s.id);i&&e[s.action]&&(i.onclick=()=>{this.contextMenu.style.display="none",e[s.action]()})})}showFolderContextMenu(t,e){this.clearSelection(),this.addToSelection(e),this.contextMenu.innerHTML=this.createContextMenuHTML(this.templates.folderContextMenu);const s={openFolder:()=>this.openFolder(e.dataset.folderName),deleteFolder:async()=>{await this.fs.deleteItem(["Desktop"],e.dataset.folderName),e.remove(),this.clearSelection()},renameFolder:async()=>{const i=prompt("Enter new folder name:",e.dataset.folderName);i&&i!==e.dataset.folderName&&(await this.fs.renameItem(["Desktop"],e.dataset.folderName,i),e.dataset.folderName=i,e.querySelector("span").textContent=i)}};this.attachContextMenuHandlers(this.templates.folderContextMenu,s),this.positionContextMenu(t)}showIconContextMenu(t,e){this.state.selectedIcons.has(e)||(this.clearSelection(),this.addToSelection(e));const s=Array.from(this.state.selectedIcons),i=Q(s);this.contextMenu.innerHTML=this.createContextMenuHTML(this.templates.iconContextMenu);const n={open:()=>this.appLauncher.launch(i.dataset.app,i),cut:()=>this.cutSelectedIcons(s),copy:()=>this.copySelectedIcons(s),delete:()=>this.deleteSelectedIcons(s),properties:()=>this.showPropertiesDialog(i)};this.attachContextMenuHandlers(this.templates.iconContextMenu,n),this.positionContextMenu(t)}cutSelectedIcons(t){this.state.clipboard={action:"cut",icons:t.map(e=>({element:e,data:{...L(e.dataset,["app","name","path"]),className:e.className,innerHTML:e.innerHTML}}))}}copySelectedIcons(t){this.state.clipboard={action:"copy",icons:t.map(e=>({data:{...L(e.dataset,["app","name","path"]),className:e.className,innerHTML:e.innerHTML}}))}}deleteSelectedIcons(t){t.forEach(e=>{this.state.selectedIcons.delete(e),e.remove()})}extractIconData(t){return{...L(t.dataset,["app","name","path"]),innerHTML:t.innerHTML,className:t.className}}createPropertiesContent(t){const e=t.getBoundingClientRect(),s=t.dataset.app,i=tt(this.appLauncher,`appMap.${s}`,{}),n=t.querySelector("div"),r={Name:n?n.textContent.trim():"Unknown",Type:s||"Application",Path:{explorer:"/static/icons/pc.webp",notepad:"/static/icons/notepad.webp",flash:"/static/icons/flash.png"}[s]||"/static/icons/file.png","App Type":i.type,"SWF Path":i.swf,URL:i.url,Width:`${Math.round(e.width)}px`,Height:`${Math.round(e.height)}px`,Left:`${Math.round(e.left)}px`,Top:`${Math.round(e.top)}px`,"Z-Index":t.style.zIndex||"0"};return Object.entries(r).filter(([,l])=>l!==void 0&&!et(l)).map(([l,d])=>`<div style="margin:2px 0;">${l}: ${d}</div>`).join("")}createWindowHTML(t,e){return`
      <div class="window-header">
        <span>${t}</span>
        <div class="window-controls">
          <button class="minimize-btn" title="Minimize">−</button>
          <button class="maximize-btn" title="Maximize">□</button>
          <button class="close-btn" title="Close">X</button>
        </div>
      </div>
      <div class="window-content" style="width:100%; height:100%; overflow:auto; user-select:text; padding:10px;">
        ${e}
      </div>
    `}showPropertiesDialog(t){const e=t.id||`icon-${Date.now()}`,s=t.querySelector("div"),n=`Properties: ${s?s.textContent.trim():"Unknown"}`,o=this.createPropertiesContent(t),a=this.appLauncher.wm.createWindow(`${e}-props`,n,"300px","auto");a.innerHTML=this.createWindowHTML(n,o),x.appendChild(a),this.appLauncher.wm.makeDraggable(a),this.appLauncher.wm.makeResizable(a),this.appLauncher.wm.setupWindowControls(a)}showDesktopContextMenu(t){this.contextMenu.innerHTML=this.createContextMenuHTML(this.templates.desktopContextMenu);const e={newNotepad:()=>this.notepadApp.open(),newFolder:async()=>{const s=prompt("Enter folder name:","New Folder");s&&(await this.fs.createFolder(["Desktop"],s),this.createFolderIcon(s),await this.saveFolderPosition(s))},openExplorer:()=>this.explorerApp.open(),paste:()=>this.pasteIcons(t.pageX,t.pageY),refresh:async()=>{document.querySelectorAll(".folder-icon").forEach(i=>i.remove()),await this.loadDesktopItems()}};this.attachContextMenuHandlers(this.templates.desktopContextMenu,e),this.positionContextMenu(t)}async initializeDesktopFiles(){await this.fs.ensureFolder(["Desktop"]);const t=document.querySelectorAll(".icon.selectable:not(.folder-icon)");for(const e of t){const s=e.querySelector("div"),i=s?s.textContent.trim():"Unknown",n=e.dataset.app,o=`${i}.desktop`,a=await this.fs.getFileContent(["Desktop"],o);if(a){const r=JSON.parse(a);if(r.position&&r.position.leftPercent!==void 0){const l=this.percentToPx(r.position.leftPercent,"x"),d=this.percentToPx(r.position.topPercent,"y");Object.assign(e.style,{left:`${l}px`,top:`${d}px`}),e.dataset.leftPercent=r.position.leftPercent,e.dataset.topPercent=r.position.topPercent}}else{const l=JSON.stringify({app:n,name:i,path:{explorer:"/static/icons/pc.webp",notepad:"/static/icons/notepad.webp",flash:"/static/icons/flash.png"}[n]||"/static/icons/file.png"});await this.fs.createFile(["Desktop"],o,l,"text")}}await this.loadDesktopItems()}async loadDesktopItems(){const t=await this.fs.getFolder(["Desktop"]);for(const[e,s]of Object.entries(t))s.type||await this.createFolderIcon(e)}async createFolderIcon(t){const e=document.querySelector(`.folder-icon[data-folder-name="${t}"]`);if(e)return e;const s=document.createElement("div");s.className="icon selectable folder-icon",s.dataset.folderName=t,s.innerHTML=`
      <img src="/static/icons/file.png" style="width:64px;height:64px">
      <div>${t}</div>
    `,this.desktop.appendChild(s),this.makeIconInteractable(s);const i=`.${t}.folder`,n=await this.fs.getFileContent(["Desktop"],i);if(n){const o=JSON.parse(n);if(o.position&&o.position.leftPercent!==void 0){const a=this.percentToPx(o.position.leftPercent,"x"),r=this.percentToPx(o.position.topPercent,"y");Object.assign(s.style,{left:`${a}px`,top:`${r}px`}),s.dataset.leftPercent=o.position.leftPercent,s.dataset.topPercent=o.position.topPercent}else this.snapIconToGrid(s)}else this.snapIconToGrid(s);return s}async saveFolderPosition(t){if(!this.state.isUserDragging)return;const e=document.querySelector(`.folder-icon[data-folder-name="${t}"]`);if(!e)return;const s=parseFloat(e.dataset.leftPercent)||this.pxToPercent(parseFloat(e.style.left)||0,"x"),i=parseFloat(e.dataset.topPercent)||this.pxToPercent(parseFloat(e.style.top)||0,"y"),n=`.${t}.folder`,o=JSON.stringify({type:"folder",name:t,position:{leftPercent:s,topPercent:i}});await this.fs.createFile(["Desktop"],n,o,"text")}async onDragEnd(){if(this.state.isUserDragging)if(this.state.isUserDragging=!1,this.state.dragTarget){const t=this.state.dragTarget.dataset.folderName;await this.moveIconsToFolder(Array.from(this.state.selectedIcons),t),this.state.dragTarget.style.outline="",this.state.dragTarget=null}else{this.state.selectedIcons.forEach(t=>{this.snapIconToGrid(t),Object.assign(t.style,{opacity:"1",zIndex:"1",cursor:"default"})}),await this.updateDesktopFilePositions();for(const t of this.state.selectedIcons)t.classList.contains("folder-icon")&&await this.saveFolderPosition(t.dataset.folderName)}}positionContextMenu(t){Object.assign(this.contextMenu.style,{left:`${t.pageX}px`,top:`${t.pageY}px`,display:"block"})}pasteIcons(t,e){if(!this.state.clipboard)return;const{action:s,icons:i}=this.state.clipboard;i.forEach((n,o)=>{let a=t+o*10,r=e+o*10;const l=this.createIconElement(n.data,a,r);this.makeIconInteractable(l),this.desktop.appendChild(l),this.snapIconToGrid(l),s==="cut"&&n.element&&n.element.remove()}),s==="cut"&&(this.state.clipboard=null)}createIconElement(t,e,s){const i=document.createElement("div");return i.className=t.className,i.innerHTML=t.innerHTML,Object.assign(i.dataset,L(t,["app","name","path"])),Object.assign(i.style,{position:"absolute",left:`${e}px`,top:`${s}px`,userSelect:"none",webkitUserDrag:"none",cursor:"default"}),i.dataset.leftPercent=this.pxToPercent(e,"x"),i.dataset.topPercent=this.pxToPercent(s,"y"),i}setupInteractableSelection(){let t={startX:0,startY:0,isActive:!1};const e=A(this.desktop);e.resizable(!1),e.draggable({cursorChecker:()=>null,listeners:{start:s=>{this.appLauncher.wm.isDraggingWindow||(t={startX:s.pageX,startY:s.pageY,isActive:!0},this.initializeSelectionBox(t.startX,t.startY),this.clearSelection())},move:s=>{!t.isActive||s.target!==this.desktop||(this.updateSelectionBox(s,t),this.updateIconSelection())},end:()=>{t.isActive&&(this.hideSelectionBox(),t.isActive=!1)}}})}initializeSelectionBox(t,e){Object.assign(this.selectionBox.style,{left:`${t}px`,top:`${e}px`,width:"0px",height:"0px",display:"block"})}updateSelectionBox(t,e){const s=Math.abs(t.pageX-e.startX),i=Math.abs(t.pageY-e.startY),n=Math.min(t.pageX,e.startX),o=Math.min(t.pageY,e.startY);Object.assign(this.selectionBox.style,{width:`${s}px`,height:`${i}px`,left:`${n}px`,top:`${o}px`})}updateIconSelection(){const t=this.selectionBox.getBoundingClientRect();document.querySelectorAll(".icon.selectable").forEach(s=>{const i=s.getBoundingClientRect();this.checkOverlap(t,i)?this.addToSelection(s):this.removeFromSelection(s)})}checkOverlap(t,e){return!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom)}hideSelectionBox(){this.selectionBox.style.display="none"}setupStartMenu(){const t={home:()=>{this.explorerApp.open(),this.explorerApp.navigate("")},documents:()=>{this.explorerApp.open(),this.explorerApp.navigate(this.fs.resolveDir("Documents"))},pictures:()=>{this.explorerApp.open(),this.explorerApp.navigate(this.fs.resolveDir("Pictures"))},notes:()=>this.notepadApp.open()};this.startMenu.querySelectorAll(".start-item").forEach(e=>{e.onclick=s=>{s.stopPropagation();const i=e.dataset.path;t[i]&&t[i](),this.startMenu.style.display="none"}})}}const bt=80,j=100,P=5;function J(){const c=x.querySelectorAll(".icon"),t=x.clientHeight;let e=P,s=P;requestAnimationFrame(()=>{for(const i of c)Object.assign(i.style,{position:"absolute",left:`${e}px`,top:`${s}px`}),s+=j+P,s+j>t&&(s=P,e+=bt+P)})}window.addEventListener("load",J);window.addEventListener("resize",J);class vt{constructor(){}open(t){if(document.getElementById("music-win")){console.log("bringing window to front"),t.bringToFront(document.getElementById("music-win"));return}console.log("Creating window");const e=t.createWindow("music-win","MUSIC");e.innerHTML=`
    <div class="window-header">
      <span>MUSIC</span>
      ${t.getWindowControls()}
    </div>
    <div class="window-content" style="width:100%; height:100%;">
      <div id="player-container" style="display:flex; flex-direction:column; align-items:center; gap:10px; padding:10px;"></div>
      </div>
    </div>`,x.appendChild(e),R.renderMusicPage(document.getElementById("player-container")),t.makeDraggable(e),t.makeResizable(e),t.setupWindowControls(e),t.addToTaskbar(e.id,"MUSIC","/static/icons/music.png")}}const M=new it,S=new lt,$=new gt(M,S,null),R=new ot(M,S,$);$.setExplorer(R);const xt=new ct(S),kt=new st(M,S),Ct=new vt,Et=new wt(S),V=new ft(S,M,Ct,R,kt,$,xt,Et);console.log(H);new yt(V,$,R,M);D.startClock();D.setRandomWallpaper();const It=window.location.search,St=new URLSearchParams(It),z=St.get("game");z&&setTimeout(()=>{V.launch(z)},100);console.log("Howdy, devtools user! the source of this site is available at: https://github.com/Reeyuki/reeyuki.github.io");mt();
